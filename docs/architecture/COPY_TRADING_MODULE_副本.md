# NOFX çœŸäººé¢†èˆªå‘˜è·Ÿå•ç³»ç»Ÿè®¾è®¡æ–‡æ¡£

> **ç‰ˆæœ¬**: v1.1  
> **çŠ¶æ€**: è®¾è®¡é˜¶æ®µ  
> **ä½œè€…**: Core Engineering Team  
> **åˆ›å»ºæ—¥æœŸ**: 2025-12-16  
> **æ›´æ–°æ—¥æœŸ**: 2025-12-16

---

## ç›®å½•

1. [æ¦‚è¿°](#1-æ¦‚è¿°)
2. [è·Ÿå•è§„åˆ™ä¸äº¤æ˜“åŠ¨ä½œ](#2-è·Ÿå•è§„åˆ™ä¸äº¤æ˜“åŠ¨ä½œ)
3. [ç³»ç»Ÿæ¶æ„](#3-ç³»ç»Ÿæ¶æ„)
4. [æ ¸å¿ƒæ¨¡å—è®¾è®¡](#4-æ ¸å¿ƒæ¨¡å—è®¾è®¡)
5. [æ•°æ®æ¨¡å‹](#5-æ•°æ®æ¨¡å‹)
6. [API è®¾è®¡](#6-api-è®¾è®¡)
7. [è·Ÿå•æ¯”ä¾‹ç®—æ³•](#7-è·Ÿå•æ¯”ä¾‹ç®—æ³•)
8. [å‰ç«¯é›†æˆ](#8-å‰ç«¯é›†æˆ)
9. [é£é™©é¢„è­¦æœºåˆ¶](#9-é£é™©é¢„è­¦æœºåˆ¶)
10. [æ—¥å¿—è§„èŒƒ](#10-æ—¥å¿—è§„èŒƒ)
11. [å®ç°è·¯çº¿å›¾](#11-å®ç°è·¯çº¿å›¾)
12. [é™„å½•](#12-é™„å½•)

---

## 1. æ¦‚è¿°

### 1.1 é¡¹ç›®èƒŒæ™¯

NOFX å½“å‰çš„äº¤æ˜“å†³ç­–å®Œå…¨ç”± AI æ¨¡å‹é©±åŠ¨ã€‚ä¸ºæ‰©å±•ä¿¡å·æ¥æºï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥ã€ŒçœŸäººé¢†èˆªå‘˜è·Ÿå•ã€åŠŸèƒ½ï¼Œå…è®¸ç”¨æˆ·è·Ÿéš Hyperliquid æˆ– OKX ä¸Šä¼˜ç§€äº¤æ˜“å‘˜çš„æ“ä½œè¿›è¡ŒåŒæ­¥äº¤æ˜“ã€‚

### 1.2 è®¾è®¡ç›®æ ‡

| ç›®æ ‡ | æè¿° |
|------|------|
| **æ’ä»¶åŒ–** | è·Ÿå•æ¨¡å—ä½œä¸ºç‹¬ç«‹æ’ä»¶ï¼Œå¯æ’æ‹”ï¼Œä¸å½±å“æ ¸å¿ƒç³»ç»Ÿ |
| **æœ€å°ä¾µå…¥** | å¤ç”¨ç°æœ‰æ‰§è¡Œå±‚ã€ä»ªè¡¨ç›˜ã€æ—¥å¿—ç³»ç»Ÿï¼Œé¿å…é‡å¤é€ è½®å­ |
| **å¤šè´¦æˆ·éš”ç¦»** | åŸºäº `trader_id` å®Œå…¨éš”ç¦»ï¼Œæ¯ä¸ª Trader ç»‘å®šç‹¬ç«‹çš„ Provider å®ä¾‹ |
| **é£é™©éš”ç¦»** | æ’ä»¶å¼‚å¸¸æ—¶è‡ªåŠ¨é™çº§/ç†”æ–­ï¼Œä¸å½±å“ä¸»ç³»ç»Ÿç¨³å®šæ€§ |
| **å‘åå…¼å®¹** | å†³ç­–æ¥å£ï¼ˆDecision APIï¼‰ä¿æŒå‘åå…¼å®¹ï¼Œä¾¿äºæœªæ¥å‡çº§ |

### 1.3 æ ¸å¿ƒç†å¿µ

å°†ã€Œè·Ÿå•ã€è§†ä¸ºä¸€ç§ **Decision Providerï¼ˆå†³ç­–æä¾›è€…ï¼‰**ï¼Œä¸ç°æœ‰ AI Decision Provider å¹³è¡Œã€‚

**å…³é”®åŸåˆ™ï¼šé¢†èˆªå‘˜çš„æ‰€æœ‰äº¤æ˜“åŠ¨ä½œéƒ½è¦æ— æ¡ä»¶è·Ÿéšï¼Œç³»ç»Ÿä¸åšä»»ä½•é™åˆ¶ï¼Œåªåšé¢„è­¦æ—¥å¿—ã€‚**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Decision Layer (å†³ç­–å±‚)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  AI Provider    â”‚         â”‚  Copy Trading Provider       â”‚   â”‚
â”‚  â”‚  (ç°æœ‰)         â”‚         â”‚  (æ–°å¢ - æ’ä»¶åŒ–)              â”‚   â”‚
â”‚  â”‚                 â”‚         â”‚                              â”‚   â”‚
â”‚  â”‚ - DeepSeek      â”‚         â”‚ - Hyperliquid Tracker        â”‚   â”‚
â”‚  â”‚ - Qwen          â”‚         â”‚ - OKX Tracker                â”‚   â”‚
â”‚  â”‚ - GPT/Claude    â”‚         â”‚                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                                  â”‚                   â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                          â”‚                                       â”‚
â”‚                          â–¼                                       â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚              â”‚  Unified Decision API â”‚                          â”‚
â”‚              â”‚  (ç»Ÿä¸€å†³ç­–æ¥å£)        â”‚                          â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Execution Layer (æ‰§è¡Œå±‚)                       â”‚
â”‚                   (å¤ç”¨ç°æœ‰ trader/* æ¨¡å—)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. è·Ÿå•è§„åˆ™ä¸äº¤æ˜“åŠ¨ä½œ

### 2.1 äº¤æ˜“åŠ¨ä½œå®šä¹‰

#### 2.1.1 Hyperliquid é¢†èˆªå‘˜åŠ¨ä½œ

| åŠ¨ä½œ | è¯´æ˜ | API å­—æ®µæ ‡è¯† |
|------|------|-------------|
| **å¼€ä»“ (Open)** | æ— æŒä»“ â†’ å»ºç«‹æ–°ä»“ä½ | `dir: "Open Long"` / `"Open Short"` |
| **åŠ ä»“ (Add)** | å·²æœ‰æŒä»“ â†’ å¢åŠ ä»“ä½ | `dir: "Open Long/Short"` + `startPosition != 0` |
| **å‡ä»“ (Reduce)** | å·²æœ‰æŒä»“ â†’ éƒ¨åˆ†å¹³ä»“ | `dir: "Close Long/Short"` + ä»“ä½æœªæ¸…é›¶ |
| **å¹³ä»“ (Close)** | å·²æœ‰æŒä»“ â†’ å®Œå…¨å¹³ä»“ | `dir: "Close Long/Short"` + ä»“ä½æ¸…é›¶ |
| **åå‘å¼€ä»“ (Reverse)** | å¹³æ‰åŸä»“ä½ â†’ å¼€åå‘ä»“ä½ | ä¸€æ¬¡æ“ä½œåŒæ—¶å‡ºç°å¹³ä»“å’Œåå‘å¼€ä»“ |

#### 2.1.2 OKX é¢†èˆªå‘˜åŠ¨ä½œ

| åŠ¨ä½œ | è¯´æ˜ | API å­—æ®µæ ‡è¯† |
|------|------|-------------|
| **å¼€ä»“ (Open)** | æ— æŒä»“ â†’ å»ºç«‹æ–°ä»“ä½ | `side: "buy"` + `posSide: "long"` æˆ– `side: "sell"` + `posSide: "short"` |
| **åŠ ä»“ (Add)** | å·²æœ‰æŒä»“ â†’ å¢åŠ ä»“ä½ | åŒå¼€ä»“æ–¹å‘ï¼Œä»“ä½å¢åŠ  |
| **å‡ä»“ (Reduce)** | å·²æœ‰æŒä»“ â†’ éƒ¨åˆ†å¹³ä»“ | `side: "sell"` + `posSide: "long"` æˆ– `side: "buy"` + `posSide: "short"` |
| **å¹³ä»“ (Close)** | å·²æœ‰æŒä»“ â†’ å®Œå…¨å¹³ä»“ | åŒå‡ä»“ï¼Œä»“ä½æ¸…é›¶ |

> âš ï¸ **æ³¨æ„**ï¼šOKX æ²¡æœ‰åå‘å¼€ä»“åŠ¨ä½œï¼Œåªæœ‰ä¸Šè¿°å››ç§åŸºæœ¬åŠ¨ä½œã€‚

### 2.2 æ ¸å¿ƒè·Ÿå•è§„åˆ™

#### 2.2.1 åªè·Ÿæ–°å¼€ä»“åŸåˆ™

**æ ¸å¿ƒè§„åˆ™ï¼šåªè·Ÿé¢†èˆªå‘˜çš„æ–°å¼€ä»“ï¼Œä»¥åŠè¯¥ä»“ä½åç»­çš„æ‰€æœ‰æ“ä½œï¼ˆåŠ ä»“ã€å‡ä»“ã€å¹³ä»“ï¼‰ã€‚é¢†èˆªå‘˜çš„å†å²ä»“ä½çš„ä»»ä½•æ“ä½œéƒ½ä¸è·Ÿã€‚**

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚              åªè·Ÿæ–°å¼€ä»“åŸåˆ™                          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                                              â”‚
                    â–¼                                              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   é¢†èˆªå‘˜ æ–°å¼€ä»“        â”‚                    â”‚   é¢†èˆªå‘˜ å†å²ä»“ä½      â”‚
        â”‚   (å¯åŠ¨è·Ÿå•åçš„ä»“ä½)   â”‚                    â”‚   (æˆ‘ä»¬æ²¡è·Ÿè¿‡çš„ä»“ä½)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                                             â”‚
                    â–¼                                             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   âœ… è·Ÿéšæ‰€æœ‰æ“ä½œ      â”‚                    â”‚   âŒ å¿½ç•¥æ‰€æœ‰æ“ä½œ      â”‚
        â”‚   â€¢ å¼€ä»“ â†’ è·Ÿ          â”‚                    â”‚   â€¢ åŠ ä»“ â†’ ä¸è·Ÿ        â”‚
        â”‚   â€¢ åŠ ä»“ â†’ è·Ÿ          â”‚                    â”‚   â€¢ å‡ä»“ â†’ ä¸è·Ÿ        â”‚
        â”‚   â€¢ å‡ä»“ â†’ è·Ÿ          â”‚                    â”‚   â€¢ å¹³ä»“ â†’ ä¸è·Ÿ        â”‚
        â”‚   â€¢ å¹³ä»“ â†’ è·Ÿ          â”‚                    â”‚   (é¿å…é«˜ä½æ¥ç›˜)       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ**

1. **å¼€ä»“ä»·ä¸€è‡´**ï¼šä¿è¯æˆ‘ä»¬å’Œé¢†èˆªå‘˜çš„å¼€ä»“ä»·æ ¼ä¸€è‡´
2. **é¿å…é«˜ä½æ¥ç›˜**ï¼šä¸ä¼šåœ¨é¢†èˆªå‘˜å†å²ä»“ä½çš„é«˜/ä½ä½è¢«åŠ¨å…¥åœº
3. **é£é™©å¯æ§**ï¼šå®Œæ•´è·Ÿéšä¸€ä¸ªä»“ä½çš„å…¨ç”Ÿå‘½å‘¨æœŸï¼ˆå¼€ä»“ â†’ åŠ ä»“ â†’ å‡ä»“ â†’ å¹³ä»“ï¼‰

#### 2.2.2 åˆ¤æ–­æ–°å¼€ä»“ vs åŠ ä»“çš„æ–¹æ³•

**åˆ¤æ–­æ–¹æ¡ˆï¼šæœ¬åœ°ä»“ä½å¯¹æ¯”æ³•ï¼ˆæœ€ç®€å•ã€æœ€å‡†ç¡®ï¼‰**

```go
// åˆ¤æ–­é€»è¾‘ä¼ªä»£ç 
func shouldFollowSignal(signal TradeSignal) (follow bool, reason string) {
    localPosition := getLocalPosition(signal.Symbol, signal.PositionSide)
    
    if signal.Action == "open" {
        if localPosition == nil || localPosition.Size == 0 {
            // æœ¬åœ°æ— ä»“ä½ + é¢†èˆªå‘˜å¼€ä»“ = æ–°å¼€ä»“ï¼ˆè·Ÿï¼ï¼‰
            return true, "æ–°å¼€ä»“ä¿¡å·ï¼Œæœ¬åœ°æ— æŒä»“"
        } else {
            // æœ¬åœ°æœ‰ä»“ä½ + é¢†èˆªå‘˜"å¼€ä»“" = å…¶å®æ˜¯åŠ ä»“ï¼ˆè·Ÿï¼å› ä¸ºæ˜¯æˆ‘ä»¬è·Ÿè¿‡çš„ä»“ä½ï¼‰
            return true, "åŠ ä»“ä¿¡å·ï¼Œè·Ÿéšå·²æœ‰ä»“ä½"
        }
    }
    
    if signal.Action == "add" || signal.Action == "reduce" || signal.Action == "close" {
        if localPosition == nil || localPosition.Size == 0 {
            // æœ¬åœ°æ— ä»“ä½ + é¢†èˆªå‘˜åŠ ä»“/å‡ä»“/å¹³ä»“ = å†å²ä»“ä½æ“ä½œï¼ˆä¸è·Ÿï¼ï¼‰
            return false, "å¿½ç•¥ï¼šé¢†èˆªå‘˜å†å²ä»“ä½æ“ä½œï¼Œæˆ‘ä»¬æœªè·Ÿéšè¯¥ä»“ä½"
        } else {
            // æœ¬åœ°æœ‰ä»“ä½ = æ˜¯æˆ‘ä»¬è·Ÿè¿‡çš„ä»“ä½ï¼ˆè·Ÿï¼ï¼‰
            return true, "è·Ÿéšå·²æœ‰ä»“ä½çš„æ“ä½œ"
        }
    }
    
    return false, "æœªçŸ¥æ“ä½œç±»å‹"
}
```

**åˆ¤æ–­æµç¨‹å›¾ï¼š**

```
           é¢†èˆªå‘˜å‘å‡ºäº¤æ˜“ä¿¡å·
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   æŸ¥è¯¢æœ¬åœ°ä»“ä½çŠ¶æ€   â”‚
        â”‚   (åŒå¸ç§åŒæ–¹å‘)     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                      â”‚
        â–¼                      â–¼
   æœ¬åœ°æœ‰ä»“ä½               æœ¬åœ°æ— ä»“ä½
        â”‚                      â”‚
        â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€ ä¿¡å·=å¼€ä»“ â”€â”€â”€â”€â”€â”€â–¶ âœ… è·Ÿéšï¼ˆæ–°å¼€ä»“ï¼‰
        â”‚                      â”‚
        â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€ ä¿¡å·=å…¶ä»– â”€â”€â”€â”€â”€â”€â–¶ âŒ å¿½ç•¥ï¼ˆå†å²ä»“ä½ï¼‰
        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ä»»ä½•ä¿¡å· â”€â”€â”€â”€â”€â”€â–¶ âœ… è·Ÿéšï¼ˆå·²è·Ÿä»“ä½ï¼‰
```

#### 2.2.3 åˆ¤æ–­å‡ä»“ vs å¹³ä»“çš„æ–¹æ³•

**åˆ¤æ–­æ–¹æ¡ˆï¼šé¢†èˆªå‘˜ä»“ä½å¯¹æ¯”æ³•ï¼ˆåŒæ ·ç®€å•å‡†ç¡®ï¼‰**

æ£€æµ‹åˆ°å‡ä»“/å¹³ä»“ç±»äº¤æ˜“åŠ¨ä½œï¼ˆ`Close Long/Short`ï¼‰åï¼Œç›´æ¥æŸ¥çœ‹é¢†èˆªå‘˜çš„å®æ—¶æŒä»“ï¼š
- **é¢†èˆªå‘˜è¯¥å¸ç§ä»“ä½ = 0** â†’ å¹³ä»“ï¼ˆå…¨éƒ¨å¹³æ‰ï¼‰
- **é¢†èˆªå‘˜è¯¥å¸ç§ä»“ä½ > 0** â†’ å‡ä»“ï¼ˆéƒ¨åˆ†å¹³æ‰ï¼‰

```go
// åˆ¤æ–­å‡ä»“ vs å¹³ä»“
func determineCloseAction(signal TradeSignal, leaderState AccountState) string {
    // è·å–é¢†èˆªå‘˜è¯¥å¸ç§çš„å½“å‰æŒä»“
    leaderPosition := leaderState.Positions[signal.Symbol]
    
    if leaderPosition == nil || leaderPosition.Size == 0 {
        // é¢†èˆªå‘˜è¯¥å¸ç§ä»“ä½å·²æ¸…é›¶ = å¹³ä»“
        return "close"
    } else {
        // é¢†èˆªå‘˜è¯¥å¸ç§ä»“ä½ä»æœ‰ = å‡ä»“
        return "reduce"
    }
}
```

**åˆ¤æ–­æµç¨‹å›¾ï¼š**

```
       é¢†èˆªå‘˜å‘å‡º Close Long/Short ä¿¡å·
                      â”‚
                      â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  æŸ¥è¯¢é¢†èˆªå‘˜å®æ—¶æŒä»“çŠ¶æ€  â”‚
           â”‚  (åŒå¸ç§åŒæ–¹å‘)          â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                        â”‚
           â–¼                        â–¼
    é¢†èˆªå‘˜ä»“ä½ = 0              é¢†èˆªå‘˜ä»“ä½ > 0
           â”‚                        â”‚
           â–¼                        â–¼
      ğŸ“‰ å¹³ä»“åŠ¨ä½œ                ğŸ“‰ å‡ä»“åŠ¨ä½œ
    (æˆ‘æ–¹ä¹Ÿå…¨éƒ¨å¹³ä»“)          (æˆ‘æ–¹æŒ‰æ¯”ä¾‹å‡ä»“)
```

**ä¸ºä»€ä¹ˆè¿™æ ·åˆ¤æ–­æœ€å‡†ç¡®ï¼Ÿ**

1. **API ä¸åŒºåˆ†å‡ä»“/å¹³ä»“**ï¼šHyperliquid çš„ `dir` å­—æ®µåªæ˜¾ç¤º `Close Long/Short`ï¼Œä¸åŒºåˆ†æ˜¯å‡ä»“è¿˜æ˜¯å¹³ä»“
2. **å®æ—¶æŒä»“æ˜¯çœŸç›¸**ï¼šæ£€æŸ¥é¢†èˆªå‘˜çš„å®æ—¶æŒä»“çŠ¶æ€ï¼Œèƒ½å‡†ç¡®åˆ¤æ–­ä»–æ˜¯éƒ¨åˆ†å¹³è¿˜æ˜¯å…¨éƒ¨å¹³
3. **è·Ÿå•åŠ¨ä½œä¸€è‡´**ï¼š
   - é¢†èˆªå‘˜å¹³ä»“ â†’ æˆ‘ä»¬ä¹Ÿå¹³ä»“ï¼ˆå…¨éƒ¨ï¼‰
   - é¢†èˆªå‘˜å‡ä»“ â†’ æˆ‘ä»¬æŒ‰æ¯”ä¾‹å‡ä»“ï¼ˆéƒ¨åˆ†ï¼‰

#### 2.2.3 Hyperliquid åå‘å¼€ä»“å¤„ç†

**å¤„ç†ç­–ç•¥ï¼šå°†åå‘å¼€ä»“æ‹†åˆ†ä¸º"å…ˆå¹³åå¼€"ä¸¤ä¸ªç‹¬ç«‹äº‹ä»¶**

```
é¢†èˆªå‘˜åå‘å¼€ä»“åŠ¨ä½œ
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Hyperliquid API è¿”å›çš„åå‘å¼€ä»“æ•°æ®ï¼š              â”‚
â”‚  ä¾‹ï¼šä» Long åå‘åˆ° Short                         â”‚
â”‚  â€¢ å…ˆå‡ºç° "Close Long" äº‹ä»¶                       â”‚
â”‚  â€¢ å†å‡ºç° "Open Short" äº‹ä»¶                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               è·Ÿå•ç³»ç»Ÿå¤„ç†é€»è¾‘                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                   â”‚
â”‚  äº‹ä»¶1: Close Long                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æœ¬åœ°æœ‰ Long ä»“ä½ï¼Ÿ                           â”‚ â”‚
â”‚  â”‚   â”œâ”€â”€ æ˜¯ â†’ âœ… æ‰§è¡Œå¹³å¤š                       â”‚ â”‚
â”‚  â”‚   â””â”€â”€ å¦ â†’ âŒ å¿½ç•¥ï¼ˆæˆ‘ä»¬æ²¡è·Ÿè¿‡è¿™ä¸ªä»“ä½ï¼‰     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                   â”‚
â”‚  äº‹ä»¶2: Open Short                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æœ¬åœ°æœ‰ Short ä»“ä½ï¼Ÿ                          â”‚ â”‚
â”‚  â”‚   â”œâ”€â”€ å¦ â†’ âœ… æ‰§è¡Œå¼€ç©ºï¼ˆæ–°å¼€ä»“ï¼‰             â”‚ â”‚
â”‚  â”‚   â””â”€â”€ æ˜¯ â†’ âœ… æ‰§è¡ŒåŠ ç©ºï¼ˆåŠ ä»“ï¼‰               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸ºä»€ä¹ˆè¿™æ ·å¤„ç†æœ€ç®€å•ç¨³å®šï¼Ÿ**

1. **ä¸éœ€è¦æœ¬åœ°æ¨ç®—åå‘é‡**ï¼šç›´æ¥æŒ‰ API è¿”å›çš„äº‹ä»¶é¡ºåºå¤„ç†
2. **é€»è¾‘ç»Ÿä¸€**ï¼šå¹³ä»“å°±æ˜¯å¹³ä»“ï¼Œå¼€ä»“å°±æ˜¯å¼€ä»“ï¼Œä¸éœ€è¦ç‰¹æ®Šåˆ†æ”¯
3. **çŠ¶æ€æ¸…æ™°**ï¼šæ¯ä¸ªäº‹ä»¶ç‹¬ç«‹å¤„ç†ï¼Œä¸ä¾èµ–å¤æ‚çš„çŠ¶æ€æœº

#### 2.2.4 è¾¹ç•Œæƒ…å†µå¤„ç†

##### è¾¹ç•Œ 1ï¼šç³»ç»Ÿé‡å¯åä»“ä½çŠ¶æ€æ¢å¤

**é—®é¢˜åœºæ™¯**ï¼šç³»ç»Ÿé‡å¯å¯¼è‡´å†…å­˜çŠ¶æ€ä¸¢å¤±ï¼Œé¢†èˆªå‘˜åç»­æ“ä½œè¢«é”™è¯¯å¿½ç•¥ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š`getLocalPosition()` å¿…é¡»ä»**æŒä¹…åŒ–å­˜å‚¨**è·å–ï¼Œä¸ä¾èµ–å†…å­˜ç¼“å­˜ã€‚

```go
// âœ… æ­£ç¡®åšæ³•ï¼šä»äº¤æ˜“æ‰€/æ•°æ®åº“è·å–çœŸå®ä»“ä½
func (e *CopyTradeEngine) getLocalPosition(symbol, side string) *Position {
    // å¤ç”¨ç°æœ‰ç³»ç»Ÿçš„ä»“ä½æŸ¥è¯¢ï¼ˆå·²ç»æ˜¯æŒä¹…åŒ–çš„ï¼‰
    positions := e.followerTrader.GetPositions()  // ä»äº¤æ˜“æ‰€åŒæ­¥
    
    for _, pos := range positions {
        if pos.Symbol == symbol && pos.Side == side {
            return pos
        }
    }
    return nil
}

// âŒ é”™è¯¯åšæ³•ï¼šä¾èµ–å†…å­˜ç¼“å­˜
// var memoryCache map[string]*Position  // é‡å¯åä¸¢å¤±ï¼
```

> ğŸ’¡ ç°æœ‰ç³»ç»Ÿå·²æœ‰ `PositionSyncManager` å®šæœŸåŒæ­¥ä»“ä½ï¼Œç›´æ¥å¤ç”¨å³å¯ã€‚

##### è¾¹ç•Œ 2ï¼šç”¨æˆ·æ‰‹åŠ¨æ“ä½œä»“ä½

**é—®é¢˜åœºæ™¯**ï¼šç”¨æˆ·æ‰‹åŠ¨å¹³ä»“/åŠ ä»“ï¼Œå¯¼è‡´æœ¬åœ°ä»“ä½å’Œè·Ÿå•çŠ¶æ€ä¸ä¸€è‡´ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šè¿™æ˜¯**ç”¨æˆ·ä¸»åŠ¨è¡Œä¸º**ï¼Œç³»ç»Ÿåº”è¯¥å°Šé‡ã€‚

```go
// ç”¨æˆ·æ‰‹åŠ¨å¹³ä»“åï¼š
// - æœ¬åœ°ä»“ä½ = 0
// - é¢†èˆªå‘˜åç»­ add/reduce/close ä¼šè¢«å¿½ç•¥
// - è¿™æ˜¯åˆç†è¡Œä¸ºï¼å› ä¸ºç”¨æˆ·å·²ç»ä¸»åŠ¨é€€å‡ºè¯¥ä»“ä½

// å¦‚æœç”¨æˆ·æƒ³é‡æ–°è·Ÿéšï¼š
// - ç­‰å¾…é¢†èˆªå‘˜ä¸‹ä¸€æ¬¡æ–°å¼€ä»“å³å¯
// - ç³»ç»Ÿä¼šè‡ªåŠ¨å¼€å§‹è·Ÿéš
```

| ç”¨æˆ·æ“ä½œ | ç³»ç»Ÿè¡Œä¸º | æ˜¯å¦åˆç† |
|---------|---------|---------|
| æ‰‹åŠ¨å¹³ä»“ | åç»­æ“ä½œå¿½ç•¥ | âœ… ç”¨æˆ·ä¸»åŠ¨é€€å‡º |
| æ‰‹åŠ¨åŠ ä»“ | åç»­æŒ‰æœ¬åœ°ä»“ä½å¤„ç† | âœ… ç”¨æˆ·ä¸»åŠ¨ä»‹å…¥ |
| æ‰‹åŠ¨å‡ä»“ | åç»­æŒ‰æœ¬åœ°ä»“ä½å¤„ç† | âœ… ç”¨æˆ·ä¸»åŠ¨ä»‹å…¥ |

##### è¾¹ç•Œ 3ï¼šåå‘å¼€ä»“äº‹ä»¶ä¹±åºï¼ˆé˜²å¾¡æ€§å¤„ç†ï¼‰

**é—®é¢˜åœºæ™¯**ï¼šæç«¯ç½‘ç»œæŠ–åŠ¨å¯¼è‡´ Open Short å…ˆäº Close Long åˆ°è¾¾ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šåŠ ä¸€ä¸ª"åå‘çª—å£"ä¿æŠ¤ã€‚

```go
// åå‘çª—å£ä¿æŠ¤
type ReverseWindowProtection struct {
    recentCloses map[string]time.Time  // symbol -> close æ—¶é—´
    windowSize   time.Duration         // çª—å£å¤§å°ï¼Œå¦‚ 5 ç§’
}

func (e *CopyTradeEngine) shouldFollowSignal(signal *TradeSignal) (bool, string) {
    fill := signal.Fill
    localPosition := e.getLocalPosition(fill.Symbol, fill.PositionSide)
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯åå‘å¼€ä»“ï¼ˆå¯èƒ½ä¹±åºï¼‰
    if fill.Action == "open" && localPosition != nil {
        oppositeSide := oppositeOf(fill.PositionSide)
        oppositePosition := e.getLocalPosition(fill.Symbol, oppositeSide)
        
        // æœ¬åœ°æœ‰åå‘ä»“ä½ + æ–°å¼€ä»“ = å¯èƒ½æ˜¯åå‘å¼€ä»“çš„ä¹±åºäº‹ä»¶
        if oppositePosition != nil && oppositePosition.Size > 0 {
            // æ£€æŸ¥æ˜¯å¦åœ¨åå‘çª—å£å†…ï¼ˆæœ€è¿‘ 5 ç§’å†…æœ‰è¯¥ symbol çš„ closeï¼‰
            if e.isInReverseWindow(fill.Symbol, 5*time.Second) {
                logger.Warnf("âš ï¸ [%s] æ£€æµ‹åˆ°å¯èƒ½çš„åå‘å¼€ä»“ä¹±åº | %s | ç­‰å¾… close å…ˆæ‰§è¡Œ",
                    e.traderID, fill.Symbol)
                // æš‚å­˜è¿™ä¸ª open äº‹ä»¶ï¼Œç­‰ close æ‰§è¡Œåå†å¤„ç†
                e.pendingReverseOpens[fill.Symbol] = signal
                return false, "åå‘çª—å£ä¿æŠ¤ï¼šç­‰å¾… close å…ˆæ‰§è¡Œ"
            }
        }
    }
    
    // ... æ­£å¸¸åˆ¤æ–­é€»è¾‘
}
```

> ğŸ’¡ è¿™æ˜¯**é˜²å¾¡æ€§ç¼–ç¨‹**ï¼Œå®é™…å‘ç”Ÿæ¦‚ç‡å¾ˆä½ï¼ˆAPI æ•°æ®å·²æŒ‰æ—¶é—´æ’åºï¼‰ï¼Œä½†åŠ ä¸Šæ›´å®‰å…¨ã€‚

### 2.3 æ— æ¡ä»¶è·ŸéšåŸåˆ™

#### 2.3.1 æ ¸å¿ƒåŸåˆ™

> **ğŸ¯ é¢†èˆªå‘˜çš„æ‰€æœ‰äº¤æ˜“åŠ¨ä½œéƒ½è¦æ— æ¡ä»¶è·Ÿéšï¼Œç³»ç»Ÿä¸åšä»»ä½•é™åˆ¶ï¼Œåªåšé¢„è­¦æ—¥å¿—ã€‚**

**ä¸ºä»€ä¹ˆï¼Ÿ**

1. **çœŸäººäº¤æ˜“å‘˜æœ‰ç‹¬ç‰¹é£æ ¼**ï¼šæ¯ä¸ªé¢†èˆªå‘˜éƒ½æœ‰è‡ªå·±çš„äº¤æ˜“ç­–ç•¥å’Œé£æ ¼
2. **ç³»ç»Ÿä¸åº”å¹²é¢„å†³ç­–**ï¼šè·Ÿå•çš„æœ¬è´¨æ˜¯ä¿¡ä»»é¢†èˆªå‘˜çš„åˆ¤æ–­
3. **ä¿æŒä¸€è‡´æ€§**ï¼šé™åˆ¶æŸäº›æ“ä½œä¼šå¯¼è‡´ä»“ä½å’Œé¢†èˆªå‘˜ä¸åŒæ­¥
4. **ç”¨æˆ·è‡ªä¸»é€‰æ‹©**ï¼šç”¨æˆ·é€‰æ‹©è·Ÿå•æŸä¸ªé¢†èˆªå‘˜ï¼Œå°±æ˜¯æ¥å—å…¶å…¨éƒ¨æ“ä½œ

#### 2.3.2 é£æ§æ”¹ä¸ºé¢„è­¦æ¨¡å¼

| åŸè®¾è®¡ (é™åˆ¶æ¨¡å¼) | æ–°è®¾è®¡ (é¢„è­¦æ¨¡å¼) |
|------------------|------------------|
| æœ€å°æˆäº¤é¢ï¼šä½äºåˆ™**å¿½ç•¥**ä¿¡å· | æœ€å°æˆäº¤é¢ï¼šä½äºåˆ™**è®°å½•é¢„è­¦æ—¥å¿—**ï¼Œä»æ‰§è¡Œ |
| æœ€å¤§æˆäº¤é¢ï¼šè¶…è¿‡åˆ™**æˆªæ–­** | æœ€å¤§æˆäº¤é¢ï¼šè¶…è¿‡åˆ™**è®°å½•é¢„è­¦æ—¥å¿—**ï¼ŒæŒ‰åŸé‡‘é¢æ‰§è¡Œ |
| å¯ç”¨ä½™é¢ï¼šè¶…è¿‡95%åˆ™**é™åˆ¶** | å¯ç”¨ä½™é¢ï¼šä¸è¶³åˆ™**è®°å½•é¢„è­¦æ—¥å¿—**ï¼Œå°è¯•æœ€å¤§å¯èƒ½æ‰§è¡Œ |
| é¢‘ç‡é™åˆ¶ï¼š30ç§’å†…**æ‹’ç»** | é¢‘ç‡é™åˆ¶ï¼š**ç§»é™¤**ï¼Œé¢†èˆªå‘˜æ‰€æœ‰æ“ä½œéƒ½æ‰§è¡Œ |
| æŒä»“æ•°é‡ï¼šè¶…é™**æ‹’ç»** | æŒä»“æ•°é‡ï¼š**ç§»é™¤**ï¼Œè·Ÿéšé¢†èˆªå‘˜çš„å…¨éƒ¨ä»“ä½ |

```go
// é¢„è­¦æ—¥å¿—ç»“æ„
type CopyTradeWarning struct {
    Timestamp   time.Time
    TraderID    string
    LeaderID    string
    Symbol      string
    WarningType string    // "low_value" | "high_value" | "insufficient_balance" | etc.
    Message     string
    Signal      *TradeSignal
    
    // ä»ç„¶æ‰§è¡Œ
    Executed    bool
    ExecutedAt  time.Time
}
```

#### 2.3.3 é¢„è­¦ç±»å‹å®šä¹‰

| é¢„è­¦ç±»å‹ | è§¦å‘æ¡ä»¶ | æ—¥å¿—æ¶ˆæ¯ç¤ºä¾‹ |
|---------|---------|-------------|
| `low_value` | è®¡ç®—è·Ÿå•é‡‘é¢ < 10 USDT | "âš ï¸ è·Ÿå•é‡‘é¢è¾ƒå° (5.2 USDT)ï¼Œä»æ‰§è¡Œ" |
| `high_value` | è®¡ç®—è·Ÿå•é‡‘é¢ > è®¾å®šä¸Šé™ | "âš ï¸ è·Ÿå•é‡‘é¢è¾ƒå¤§ (5000 USDT)ï¼Œä»æ‰§è¡Œ" |
| `insufficient_balance` | å¯ç”¨ä½™é¢ä¸è¶³ | "âš ï¸ ä½™é¢ä¸è¶³ï¼Œä»¥æœ€å¤§å¯ç”¨ (980 USDT) æ‰§è¡Œ" |
| `high_frequency` | åŒå¸ç§çŸ­æ—¶é—´å¤šæ¬¡æ“ä½œ | "âš ï¸ 30ç§’å†…é‡å¤æ“ä½œ BTCUSDTï¼Œä»æ‰§è¡Œ" |
| `high_leverage` | æ æ†è¶…è¿‡æ¨èå€¼ | "âš ï¸ åŒæ­¥æ æ† 50x è¾ƒé«˜ï¼Œä»æ‰§è¡Œ" |
| `large_position_ratio` | å•ä»“ä½å æ¯”è¶…è¿‡è´¦æˆ· 50% | "âš ï¸ ä»“ä½å æ¯” 68%ï¼Œä»æ‰§è¡Œ" |

---

## 3. ç³»ç»Ÿæ¶æ„

### 3.1 æ•´ä½“æ¶æ„å›¾ï¼ˆæ›´æ–°ç‰ˆï¼‰

```
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚          External Data Sources      â”‚
                                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                    â”‚  Hyperliquid API    â”‚   OKX API     â”‚
                                    â”‚  - userFills        â”‚   - trade-recordsâ”‚
                                    â”‚  - clearinghouseStateâ”‚  - asset      â”‚
                                    â”‚                     â”‚   - position   â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚                  â”‚
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚                                                               â”‚
                         â–¼                                                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Hyperliquid Provider             â”‚     â”‚            OKX Provider                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   LeaderTracker (é¢†èˆªå‘˜è¿½è¸ªå™¨)    â”‚  â”‚     â”‚  â”‚   LeaderTracker (é¢†èˆªå‘˜è¿½è¸ªå™¨)    â”‚  â”‚
â”‚  â”‚   - è½®è¯¢/WebSocketç›‘å¬æˆäº¤è®°å½•    â”‚  â”‚     â”‚  â”‚   - è½®è¯¢ç›‘å¬æˆäº¤è®°å½•             â”‚  â”‚
â”‚  â”‚   - è§£æ dir (Open/Close/Add)    â”‚  â”‚     â”‚  â”‚   - è§£æ posSide + side          â”‚  â”‚
â”‚  â”‚   - å»é‡ (tid/ordId)              â”‚  â”‚     â”‚  â”‚   - å»é‡ (ordId)                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   PositionSync (æŒä»“åŒæ­¥å™¨)       â”‚  â”‚     â”‚  â”‚   PositionSync (æŒä»“åŒæ­¥å™¨)       â”‚  â”‚
â”‚  â”‚   - å®šæœŸåŒæ­¥é¢†èˆªå‘˜æŒä»“å¿«ç…§        â”‚  â”‚     â”‚  â”‚   - å®šæœŸåŒæ­¥é¢†èˆªå‘˜æŒä»“å¿«ç…§        â”‚  â”‚
â”‚  â”‚   - ç”¨äºæ¯”ä¾‹è®¡ç®—å’ŒçŠ¶æ€æ ¡éªŒ        â”‚  â”‚     â”‚  â”‚   - ç”¨äºæ¯”ä¾‹è®¡ç®—å’ŒçŠ¶æ€æ ¡éªŒ        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚                                                â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
                                               â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚              Copy Trading Engine                  â”‚
                       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                       â”‚  â”‚        Signal Processor (ä¿¡å·å¤„ç†å™¨)        â”‚  â”‚
                       â”‚  â”‚  - æ ‡å‡†åŒ–äº¤æ˜“ä¿¡å· (Open/Close/Add/Reduce)  â”‚  â”‚
                       â”‚  â”‚  - è®¡ç®—è·Ÿå•æ¯”ä¾‹                            â”‚  â”‚
                       â”‚  â”‚  - ç”Ÿæˆç»Ÿä¸€ Decision ç»“æ„                  â”‚  â”‚
                       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                       â”‚  â”‚        Copy Ratio Calculator                â”‚  â”‚
                       â”‚  â”‚  - æŒ‰èµ„é‡‘æ¯”ä¾‹è®¡ç®—å¼€ä»“é‡‘é¢                   â”‚  â”‚
                       â”‚  â”‚  - åº”ç”¨è·Ÿå•ç³»æ•° (100%/200%/50%)            â”‚  â”‚
                       â”‚  â”‚  - æœ€å°/æœ€å¤§é™é¢æ ¡éªŒ                       â”‚  â”‚
                       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
                                               â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚         Decision Adapter (å†³ç­–é€‚é…å™¨)             â”‚
                       â”‚  - å°†è·Ÿå•ä¿¡å·è½¬æ¢ä¸º decision.Decision ç»“æ„        â”‚
                       â”‚  - å¡«å…… reasoning (è·Ÿå•æ¥æºè¯´æ˜)                  â”‚
                       â”‚  - å…¼å®¹ç°æœ‰ decision.FullDecision æ ¼å¼            â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
                                               â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                        NOFX Core System (ç°æœ‰ç³»ç»Ÿ)                              â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
          â”‚                                                                                â”‚
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
          â”‚  â”‚ AutoTrader  â”‚   â”‚ DecisionStoreâ”‚  â”‚ Execution   â”‚   â”‚ Dashboard/Frontend â”‚ â”‚
          â”‚  â”‚ (æ‰§è¡Œè°ƒåº¦)  â”‚   â”‚ (æ—¥å¿—å­˜å‚¨)   â”‚  â”‚ (äº¤æ˜“æ‰§è¡Œ)  â”‚   â”‚ (ä»ªè¡¨ç›˜/å‰ç«¯)      â”‚ â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
          â”‚                                                                                â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ¨¡å—ç›®å½•ç»“æ„ï¼ˆç²¾ç®€ç‰ˆï¼‰

> é‡‡ç”¨ã€Œä»“ä½å¯¹æ¯”æ³•ã€åï¼Œé€»è¾‘å¤§å¹…ç®€åŒ–ï¼Œä¸éœ€è¦å¤æ‚çš„çŠ¶æ€ç®¡ç†ã€‚

```
nofx/
â”œâ”€â”€ copytrade/                      # ğŸ†• è·Ÿå•æ’ä»¶æ¨¡å— (æ–°å¢)
â”‚   â”‚
â”‚   â”œâ”€â”€ provider.go                 # é¢†èˆªå‘˜æ•°æ®è·å–ï¼ˆHL + OKX åˆå¹¶ï¼‰
â”‚   â”‚                               # - GetFills() è·å–æˆäº¤è®°å½•
â”‚   â”‚                               # - GetAccountState() è·å–æŒä»“/ä½™é¢
â”‚   â”‚
â”‚   â”œâ”€â”€ engine.go                   # è·Ÿå•æ ¸å¿ƒå¼•æ“ï¼ˆæ‰€æœ‰é€»è¾‘åˆå¹¶ï¼‰
â”‚   â”‚                               # - ä¿¡å·æ¥æ”¶ä¸å»é‡
â”‚   â”‚                               # - ä»“ä½å¯¹æ¯”åˆ¤æ–­ï¼ˆè·Ÿ/ä¸è·Ÿï¼‰
â”‚   â”‚                               # - æ¯”ä¾‹è®¡ç®—
â”‚   â”‚                               # - Decision ç”Ÿæˆ
â”‚   â”‚
â”‚   â”œâ”€â”€ types.go                    # ç±»å‹å®šä¹‰
â”‚   â”‚                               # - Fill, Position, Signal ç­‰
â”‚   â”‚
â”‚   â””â”€â”€ manager.go                  # è·Ÿå•ç®¡ç†å™¨ï¼ˆå…¥å£ï¼‰
â”‚                                   # - å¯åŠ¨/åœæ­¢
â”‚                                   # - å¤šè´¦æˆ·éš”ç¦»
â”‚
â”œâ”€â”€ store/
â”‚   â””â”€â”€ copytrade.go                # ğŸ†• è·Ÿå•é…ç½®å­˜å‚¨
â”‚
â”œâ”€â”€ api/
â”‚   â””â”€â”€ copytrade_handler.go        # ğŸ†• è·Ÿå• API å¤„ç†å™¨
â”‚
â””â”€â”€ decision/
    â””â”€â”€ engine.go                   # âš ï¸ è½»å¾®ä¿®æ”¹ï¼šå¢åŠ  Provider æ¥å£
```

### 3.3 ä¸ºä»€ä¹ˆå¯ä»¥ç²¾ç®€ï¼Ÿ

| åŸè®¾è®¡ | ç²¾ç®€å | åŸå›  |
|-------|--------|------|
| `provider/` ç›®å½• (4æ–‡ä»¶) | `provider.go` (1æ–‡ä»¶) | HL å’Œ OKX çš„ API è°ƒç”¨é€»è¾‘ç®€å•ï¼Œåˆå¹¶å³å¯ |
| `tracker/` ç›®å½• (5æ–‡ä»¶) | åˆå¹¶åˆ° `engine.go` | ä»“ä½å¯¹æ¯”æ³•ä¸éœ€è¦å¤æ‚çš„çŠ¶æ€è¿½è¸ª |
| `tracker/position_sync.go` | âŒ åˆ é™¤ | ç›´æ¥è°ƒç”¨ API è·å–å®æ—¶æŒä»“ï¼Œä¸éœ€è¦æœ¬åœ°åŒæ­¥ |
| `tracker/dedup.go` | åˆå¹¶åˆ° `engine.go` | å»é‡é€»è¾‘å¾ˆç®€å•ï¼Œå‡ åè¡Œä»£ç  |
| `engine/` ç›®å½• (4æ–‡ä»¶) | `engine.go` (1æ–‡ä»¶) | ä¿¡å·å¤„ç†ã€æ¯”ä¾‹è®¡ç®—ã€é€‚é…å™¨éƒ½å¾ˆç®€å•ï¼Œåˆå¹¶ |
| `config/` ç›®å½• | âŒ åˆ é™¤ | é…ç½®ç»“æ„æ”¾åœ¨ `store/copytrade.go` |

### 3.4 ç²¾ç®€åçš„ä»£ç é‡ä¼°ç®—

| æ–‡ä»¶ | é¢„ä¼°è¡Œæ•° | æ ¸å¿ƒåŠŸèƒ½ |
|-----|---------|---------|
| `provider.go` | ~200 è¡Œ | API è°ƒç”¨ï¼ˆHL + OKXï¼‰ |
| `engine.go` | ~400 è¡Œ | æ ¸å¿ƒé€»è¾‘ï¼ˆåˆ¤æ–­+è®¡ç®—+ç”Ÿæˆï¼‰ |
| `types.go` | ~100 è¡Œ | ç±»å‹å®šä¹‰ |
| `manager.go` | ~150 è¡Œ | ç”Ÿå‘½å‘¨æœŸç®¡ç† |
| **æ€»è®¡** | **~850 è¡Œ** | æ•´ä¸ªè·Ÿå•æ¨¡å— |

> ğŸ’¡ **è®¾è®¡åŸåˆ™**ï¼šä»“ä½å¯¹æ¯”æ³•è®©é€»è¾‘å˜ç®€å•ï¼Œä»£ç ä¹Ÿåº”è¯¥ç®€å•ã€‚ä¸è¦ä¸ºäº†"çœ‹èµ·æ¥ä¸“ä¸š"è€Œè¿‡åº¦æ‹†åˆ†ã€‚

### 3.5 å…³é”®è®¾è®¡åŸåˆ™

#### 3.5.1 å¤ç”¨ç°æœ‰ç³»ç»Ÿï¼Œä¸é‡å¤é€ è½®å­

> âš ï¸ **æ ¸å¿ƒåŸåˆ™**ï¼šè·Ÿå•æ¨¡å—ç›´æ¥æ¥å…¥ç°æœ‰ç³»ç»Ÿï¼Œå¤ç”¨å·²æœ‰çš„è®¾è®¡ï¼Œä¸å•ç‹¬è®¾è®¡ã€‚

| åŠŸèƒ½ | åšæ³• | å¤ç”¨ä»€ä¹ˆ |
|-----|------|---------|
| **å¤šè´¦æˆ·éš”ç¦»** | ç›´æ¥å¤ç”¨ | ç°æœ‰çš„ `trader_id` éš”ç¦»æœºåˆ¶ |
| **Trader ç®¡ç†** | ç›´æ¥å¤ç”¨ | ç°æœ‰çš„ `TraderManager` |
| **äº¤æ˜“æ‰§è¡Œ** | ç›´æ¥å¤ç”¨ | ç°æœ‰çš„ `trader/*` æ‰§è¡Œå™¨ |
| **ä»“ä½æŸ¥è¯¢** | ç›´æ¥å¤ç”¨ | ç°æœ‰çš„ `GetPositions()` |
| **ä½™é¢æŸ¥è¯¢** | ç›´æ¥å¤ç”¨ | ç°æœ‰çš„ `GetBalance()` |
| **æ—¥å¿—ç³»ç»Ÿ** | ç›´æ¥å¤ç”¨ | ç°æœ‰çš„ `logger` åŒ… |
| **æ•°æ®å­˜å‚¨** | ç›´æ¥å¤ç”¨ | ç°æœ‰çš„ `store` å±‚ |
| **API è·¯ç”±** | ç›´æ¥å¤ç”¨ | ç°æœ‰çš„ `api/server.go` è·¯ç”±ç»“æ„ |

#### 3.5.2 è·Ÿå• = Trader çš„ä¸€ä¸ª"å†³ç­–æº"é€‰é¡¹

```go
// ç°æœ‰ Trader ç»“æ„ï¼ˆä¸éœ€è¦å¤§æ”¹ï¼‰
type Trader struct {
    ID              string
    Name            string
    Exchange        string
    // ... ç°æœ‰å­—æ®µ
    
    // ğŸ†• æ–°å¢ï¼šå†³ç­–æ¨¡å¼
    DecisionMode    string        // "ai" | "copy_trade"
    CopyTradeConfig *CopyConfig   // è·Ÿå•é…ç½®ï¼ˆå¦‚æœ DecisionMode == "copy_trade"ï¼‰
}

// è·Ÿå•é…ç½®ï¼ˆä½œä¸º Trader çš„å±æ€§ï¼Œä¸æ˜¯ç‹¬ç«‹å®ä½“ï¼‰
type CopyConfig struct {
    ProviderType    string        // "hyperliquid" | "okx"
    LeaderID        string        // é¢†èˆªå‘˜åœ°å€/uniqueName
    CopyRatio       float64       // è·Ÿå•ç³»æ•° (1.0 = 100%)
    SyncLeverage    bool          // åŒæ­¥æ æ†
    // ... å…¶ä»–é…ç½®
}
```

#### 3.5.3 å¤šè´¦æˆ·éš”ç¦» = ç°æœ‰æœºåˆ¶

```go
// ç°æœ‰çš„ TraderManager å·²ç»å®ç°äº†å¤šè´¦æˆ·éš”ç¦»
// è·Ÿå•æ¨¡å—ç›´æ¥æ¥å…¥ï¼Œä¸éœ€è¦å•ç‹¬è®¾è®¡

// å¯åŠ¨ Trader æ—¶ï¼Œæ ¹æ® DecisionMode é€‰æ‹©å†³ç­–æº
func (m *TraderManager) StartTrader(traderID string) error {
    trader := m.traders[traderID]
    
    switch trader.DecisionMode {
    case "ai":
        // ç°æœ‰çš„ AI å†³ç­–æµç¨‹
        go m.runAIDecisionLoop(trader)
        
    case "copy_trade":
        // æ–°å¢çš„è·Ÿå•å†³ç­–æµç¨‹ï¼ˆå¤ç”¨åŒä¸€ä¸ª trader å®ä¾‹ï¼‰
        go m.runCopyTradeLoop(trader)
    }
    
    return nil
}

// è·Ÿå•å¾ªç¯å¤ç”¨ç°æœ‰çš„ trader å®ä¾‹
func (m *TraderManager) runCopyTradeLoop(trader *Trader) {
    engine := copytrade.NewEngine(
        trader.ID,
        trader.CopyTradeConfig,
        trader.Exchange,           // å¤ç”¨ç°æœ‰çš„äº¤æ˜“æ‰€è¿æ¥
        func() float64 {           // å¤ç”¨ç°æœ‰çš„ä½™é¢æŸ¥è¯¢
            return trader.GetBalance()
        },
        func() []*Position {       // å¤ç”¨ç°æœ‰çš„ä»“ä½æŸ¥è¯¢
            return trader.GetPositions()
        },
    )
    
    engine.Run()
}
```

#### 3.5.4 è¿™æ ·è®¾è®¡çš„å¥½å¤„

| å¥½å¤„ | è¯´æ˜ |
|-----|------|
| **ä»£ç æ›´å°‘** | ä¸éœ€è¦é‡å†™éš”ç¦»ã€ç®¡ç†ã€æ‰§è¡Œé€»è¾‘ |
| **å®Œå…¨å…¼å®¹** | è·Ÿå• Trader å’Œ AI Trader å…±ç”¨åŒä¸€å¥—ç®¡ç†ç•Œé¢ |
| **ç»´æŠ¤ç®€å•** | åªç»´æŠ¤ä¸€å¥—ç³»ç»Ÿï¼Œä¸ç”¨æ‹…å¿ƒä¸¤å¥—é€»è¾‘ä¸åŒæ­¥ |
| **åˆ‡æ¢æ–¹ä¾¿** | åŒä¸€ä¸ª Trader å¯ä»¥åœ¨ AI å’Œè·Ÿå•æ¨¡å¼ä¹‹é—´åˆ‡æ¢ |
| **é£æ§ç»Ÿä¸€** | å¤ç”¨ç°æœ‰çš„ä»“ä½åŒæ­¥ã€èµ„é‡‘ç®¡ç†ç­‰ |

---

## 4. æ ¸å¿ƒæ¨¡å—è®¾è®¡

### 4.1 Provider æ¨¡å— (é¢†èˆªå‘˜æ•°æ®æä¾›è€…)

#### 4.1.1 æ¥å£å®šä¹‰

```go
// copytrade/provider/interface.go

package provider

import "time"

// LeaderProvider é¢†èˆªå‘˜æ•°æ®æä¾›è€…æ¥å£
type LeaderProvider interface {
    // GetFills è·å–æœ€è¿‘æˆäº¤è®°å½•
    GetFills(leaderID string, since time.Time) ([]Fill, error)
    
    // GetAccountState è·å–è´¦æˆ·çŠ¶æ€ (èµ„äº§ + æŒä»“)
    GetAccountState(leaderID string) (*AccountState, error)
    
    // Type è¿”å›æä¾›è€…ç±»å‹
    Type() string
}

// Fill æˆäº¤è®°å½• (æ ‡å‡†åŒ–ç»“æ„)
type Fill struct {
    ID            string    // å”¯ä¸€æ ‡è¯† (HL: tid, OKX: ordId)
    Symbol        string    // äº¤æ˜“å¯¹ (BTCUSDT æ ¼å¼)
    Side          string    // "buy" | "sell"
    PositionSide  string    // "long" | "short"
    Action        string    // "open" | "close" | "add" | "reduce"
    Price         float64   // æˆäº¤ä»·æ ¼
    Size          float64   // æˆäº¤æ•°é‡
    Value         float64   // æˆäº¤ä»·å€¼ (USDT)
    Timestamp     time.Time // æˆäº¤æ—¶é—´
    ClosedPnL     float64   // å¹³ä»“ç›ˆäº (å¦‚æœ‰)
    
    // åŸå§‹æ•°æ®
    Raw           interface{}
}

// AccountState è´¦æˆ·çŠ¶æ€
type AccountState struct {
    TotalEquity     float64              // æ€»æƒç›Š
    AvailableBalance float64             // å¯ç”¨ä½™é¢
    Positions       map[string]*Position // å½“å‰æŒä»“ (symbol -> position)
    Timestamp       time.Time
}

// Position æŒä»“ä¿¡æ¯
type Position struct {
    Symbol        string
    Side          string   // "long" | "short"
    Size          float64  // æŒä»“æ•°é‡
    EntryPrice    float64  // å¼€ä»“å‡ä»·
    MarkPrice     float64  // æ ‡è®°ä»·æ ¼
    Leverage      int      // æ æ†
    MarginMode    string   // "cross" | "isolated"
    UnrealizedPnL float64
    PositionValue float64  // ä»“ä½ä»·å€¼
}
```

#### 4.1.2 Hyperliquid å®ç°

```go
// copytrade/provider/hyperliquid.go

package provider

import (
    "encoding/json"
    "fmt"
    "net/http"
    "time"
)

const (
    HLInfoAPI = "https://api.hyperliquid.xyz/info"
)

type HyperliquidProvider struct {
    client *http.Client
}

func NewHyperliquidProvider() *HyperliquidProvider {
    return &HyperliquidProvider{
        client: &http.Client{Timeout: 10 * time.Second},
    }
}

func (p *HyperliquidProvider) Type() string {
    return "hyperliquid"
}

// GetFills è·å–æˆäº¤è®°å½•
func (p *HyperliquidProvider) GetFills(leaderID string, since time.Time) ([]Fill, error) {
    req := map[string]string{
        "type": "userFills",
        "user": leaderID,
    }
    
    // è°ƒç”¨ API
    var rawFills []HLFillRaw
    if err := p.post(req, &rawFills); err != nil {
        return nil, err
    }
    
    // è½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼
    var fills []Fill
    for _, raw := range rawFills {
        ts := time.UnixMilli(raw.Time)
        if ts.Before(since) {
            continue
        }
        
        fill := Fill{
            ID:           fmt.Sprintf("%d", raw.TID),
            Symbol:       normalizeSymbol(raw.Coin),
            Price:        parseFloat(raw.Px),
            Size:         parseFloat(raw.Sz),
            Timestamp:    ts,
            ClosedPnL:    parseFloat(raw.ClosedPnl),
            Raw:          raw,
        }
        
        // è§£ææ–¹å‘
        fill.Side, fill.PositionSide, fill.Action = parseHLDirection(raw.Side, raw.Dir)
        
        // è®¡ç®—æˆäº¤ä»·å€¼
        fill.Value = fill.Price * fill.Size
        
        fills = append(fills, fill)
    }
    
    return fills, nil
}

// GetAccountState è·å–è´¦æˆ·çŠ¶æ€
func (p *HyperliquidProvider) GetAccountState(leaderID string) (*AccountState, error) {
    req := map[string]string{
        "type": "clearinghouseState",
        "user": leaderID,
    }
    
    var raw HLClearinghouseState
    if err := p.post(req, &raw); err != nil {
        return nil, err
    }
    
    state := &AccountState{
        TotalEquity:      parseFloat(raw.MarginSummary.AccountValue),
        AvailableBalance: parseFloat(raw.Withdrawable),
        Positions:        make(map[string]*Position),
        Timestamp:        time.UnixMilli(raw.Time),
    }
    
    // è§£ææŒä»“
    for _, ap := range raw.AssetPositions {
        pos := ap.Position
        symbol := normalizeSymbol(pos.Coin)
        
        size := parseFloat(pos.Szi)
        side := "long"
        if size < 0 {
            side = "short"
            size = -size
        }
        
        state.Positions[symbol] = &Position{
            Symbol:        symbol,
            Side:          side,
            Size:          size,
            EntryPrice:    parseFloat(pos.EntryPx),
            Leverage:      pos.Leverage.Value,
            MarginMode:    pos.Leverage.Type,
            UnrealizedPnL: parseFloat(pos.UnrealizedPnl),
            PositionValue: parseFloat(pos.PositionValue),
        }
    }
    
    return state, nil
}

// parseHLDirection è§£æ Hyperliquid çš„äº¤æ˜“æ–¹å‘
func parseHLDirection(side, dir string) (tradeSide, posSide, action string) {
    // side: "B" = Buy, "A" = Ask/Sell
    // dir: "Open Long", "Close Long", "Open Short", "Close Short"
    
    switch dir {
    case "Open Long":
        return "buy", "long", "open"
    case "Close Long":
        return "sell", "long", "close"
    case "Open Short":
        return "sell", "short", "open"
    case "Close Short":
        return "buy", "short", "close"
    default:
        // å…œåº•ï¼šæ ¹æ® side å’Œ startPosition åˆ¤æ–­
        if side == "B" {
            return "buy", "long", "add"
        }
        return "sell", "short", "add"
    }
}
```

#### 4.1.3 OKX å®ç°

```go
// copytrade/provider/okx.go

package provider

import (
    "encoding/json"
    "fmt"
    "net/http"
    "time"
)

const (
    OKXTradeRecordsAPI = "https://www.okx.com/priapi/v5/ecotrade/public/community/user/trade-records"
    OKXAssetAPI        = "https://www.okx.com/priapi/v5/ecotrade/public/community/user/asset"
    OKXPositionAPI     = "https://www.okx.com/priapi/v5/ecotrade/public/community/user/position-current"
)

type OKXProvider struct {
    client *http.Client
}

func NewOKXProvider() *OKXProvider {
    return &OKXProvider{
        client: &http.Client{Timeout: 10 * time.Second},
    }
}

func (p *OKXProvider) Type() string {
    return "okx"
}

// GetFills è·å–æˆäº¤è®°å½•
func (p *OKXProvider) GetFills(uniqueName string, since time.Time) ([]Fill, error) {
    now := time.Now()
    url := fmt.Sprintf(
        "%s?uniqueName=%s&startModify=%d&endModify=%d&instType=SWAP&limit=50&t=%d",
        OKXTradeRecordsAPI,
        uniqueName,
        since.UnixMilli(),
        now.UnixMilli(),
        now.UnixMilli(),
    )
    
    var resp OKXTradeRecordsResp
    if err := p.get(url, &resp); err != nil {
        return nil, err
    }
    
    if resp.Code != "0" {
        return nil, fmt.Errorf("OKX API error: %s", resp.Msg)
    }
    
    var fills []Fill
    for _, raw := range resp.Data {
        fill := Fill{
            ID:        raw.OrdId,
            Symbol:    normalizeOKXSymbol(raw.InstId),
            Price:     parseFloat(raw.AvgPx),
            Size:      parseFloat(raw.Sz),
            Value:     parseFloat(raw.Value),
            Timestamp: time.UnixMilli(parseInt(raw.FillTime)),
            Raw:       raw,
        }
        
        // è§£ææ–¹å‘
        fill.Side, fill.PositionSide, fill.Action = parseOKXDirection(raw.Side, raw.PosSide)
        
        fills = append(fills, fill)
    }
    
    return fills, nil
}

// GetAccountState è·å–è´¦æˆ·çŠ¶æ€
func (p *OKXProvider) GetAccountState(uniqueName string) (*AccountState, error) {
    // 1. è·å–èµ„äº§
    assetURL := fmt.Sprintf("%s?uniqueName=%s&t=%d", OKXAssetAPI, uniqueName, time.Now().UnixMilli())
    var assetResp OKXAssetResp
    if err := p.get(assetURL, &assetResp); err != nil {
        return nil, err
    }
    
    // 2. è·å–æŒä»“
    posURL := fmt.Sprintf("%s?uniqueName=%s&t=%d", OKXPositionAPI, uniqueName, time.Now().UnixMilli())
    var posResp OKXPositionResp
    if err := p.get(posURL, &posResp); err != nil {
        return nil, err
    }
    
    state := &AccountState{
        Positions: make(map[string]*Position),
        Timestamp: time.Now(),
    }
    
    // è§£æèµ„äº§ (USDT ä¸ºæ€»æƒç›Š)
    for _, asset := range assetResp.Data {
        if asset.Currency == "USDT" {
            state.TotalEquity = parseFloat(asset.Amount)
            state.AvailableBalance = state.TotalEquity // OKX è·Ÿå•æ¥å£ä¸å•ç‹¬è¿”å›å¯ç”¨
            break
        }
    }
    
    // è§£ææŒä»“
    for _, pd := range posResp.Data {
        for _, pos := range pd.PosData {
            symbol := normalizeOKXSymbol(pos.InstId)
            
            state.Positions[symbol] = &Position{
                Symbol:        symbol,
                Side:          pos.PosSide,
                Size:          parseFloat(pos.Pos),
                EntryPrice:    parseFloat(pos.AvgPx),
                MarkPrice:     parseFloat(pos.MarkPx),
                Leverage:      parseInt(pos.Lever),
                MarginMode:    pos.MgnMode,
                UnrealizedPnL: parseFloat(pos.Upl),
                PositionValue: parseFloat(pos.NotionalUsd),
            }
        }
    }
    
    return state, nil
}

// parseOKXDirection è§£æ OKX äº¤æ˜“æ–¹å‘
func parseOKXDirection(side, posSide string) (tradeSide, positionSide, action string) {
    positionSide = posSide // "long" | "short"
    
    // OKX: side = "buy" | "sell", posSide = "long" | "short"
    // buy + long = å¼€å¤š/åŠ å¤š
    // sell + long = å¹³å¤š/å‡å¤š
    // sell + short = å¼€ç©º/åŠ ç©º
    // buy + short = å¹³ç©º/å‡ç©º
    
    if side == "buy" && posSide == "long" {
        return "buy", "long", "open"
    } else if side == "sell" && posSide == "long" {
        return "sell", "long", "close"
    } else if side == "sell" && posSide == "short" {
        return "sell", "short", "open"
    } else if side == "buy" && posSide == "short" {
        return "buy", "short", "close"
    }
    
    return side, posSide, "unknown"
}
```

### 4.2 Tracker æ¨¡å— (é¢†èˆªå‘˜è¿½è¸ªå™¨)

```go
// copytrade/tracker/interface.go

package tracker

import (
    "context"
    "nofx/copytrade/provider"
)

// LeaderTracker é¢†èˆªå‘˜è¿½è¸ªå™¨
type LeaderTracker interface {
    // Start å¯åŠ¨è¿½è¸ª
    Start(ctx context.Context) error
    
    // Stop åœæ­¢è¿½è¸ª
    Stop()
    
    // Subscribe è®¢é˜…ä¿¡å·
    // è¿”å›ä¸€ä¸ª channelï¼Œæœ‰æ–°æˆäº¤æ—¶æ¨é€
    Subscribe() <-chan *TradeSignal
    
    // GetLeaderState è·å–é¢†èˆªå‘˜å½“å‰çŠ¶æ€
    GetLeaderState() (*provider.AccountState, error)
}

// TradeSignal äº¤æ˜“ä¿¡å· (ç»è¿‡å¤„ç†çš„æˆäº¤äº‹ä»¶)
type TradeSignal struct {
    LeaderID     string          // é¢†èˆªå‘˜ ID
    ProviderType string          // "hyperliquid" | "okx"
    Fill         *provider.Fill  // æˆäº¤è®°å½•
    
    // é¢†èˆªå‘˜è´¦æˆ·å¿«ç…§ (ç”¨äºæ¯”ä¾‹è®¡ç®—)
    LeaderEquity     float64     // é¢†èˆªå‘˜æ€»æƒç›Š
    LeaderPosition   *provider.Position // è¯¥å¸ç§çš„æŒä»“ (å¦‚æœ‰)
}
```

```go
// copytrade/tracker/hyperliquid_tracker.go

package tracker

import (
    "context"
    "sync"
    "time"
    
    "nofx/copytrade/provider"
    "nofx/logger"
)

type HyperliquidTracker struct {
    leaderID     string
    provider     *provider.HyperliquidProvider
    
    signalCh     chan *TradeSignal
    stopCh       chan struct{}
    
    // å»é‡
    seenFills    map[string]bool
    seenMu       sync.RWMutex
    
    // çŠ¶æ€ç¼“å­˜
    lastState    *provider.AccountState
    lastSync     time.Time
    
    // é…ç½®
    pollInterval time.Duration
}

func NewHyperliquidTracker(leaderID string) *HyperliquidTracker {
    return &HyperliquidTracker{
        leaderID:     leaderID,
        provider:     provider.NewHyperliquidProvider(),
        signalCh:     make(chan *TradeSignal, 100),
        stopCh:       make(chan struct{}),
        seenFills:    make(map[string]bool),
        pollInterval: 3 * time.Second, // 3ç§’è½®è¯¢ä¸€æ¬¡
    }
}

func (t *HyperliquidTracker) Start(ctx context.Context) error {
    logger.Infof("ğŸ¯ Starting Hyperliquid tracker for leader: %s", t.leaderID)
    
    // åˆå§‹åŒæ­¥çŠ¶æ€
    state, err := t.provider.GetAccountState(t.leaderID)
    if err != nil {
        return fmt.Errorf("failed to get initial state: %w", err)
    }
    t.lastState = state
    t.lastSync = time.Now()
    
    // å¯åŠ¨è½®è¯¢åç¨‹
    go t.pollLoop(ctx)
    
    return nil
}

func (t *HyperliquidTracker) Stop() {
    close(t.stopCh)
}

func (t *HyperliquidTracker) Subscribe() <-chan *TradeSignal {
    return t.signalCh
}

func (t *HyperliquidTracker) GetLeaderState() (*provider.AccountState, error) {
    // å¦‚æœç¼“å­˜è¿‡æœŸ (>30ç§’)ï¼Œé‡æ–°è·å–
    if time.Since(t.lastSync) > 30*time.Second {
        state, err := t.provider.GetAccountState(t.leaderID)
        if err != nil {
            return t.lastState, nil // è¿”å›æ—§ç¼“å­˜
        }
        t.lastState = state
        t.lastSync = time.Now()
    }
    return t.lastState, nil
}

func (t *HyperliquidTracker) pollLoop(ctx context.Context) {
    ticker := time.NewTicker(t.pollInterval)
    defer ticker.Stop()
    
    // é¦–æ¬¡è¿è¡Œï¼šè·å–æœ€è¿‘æˆäº¤ä½œä¸ºåŸºçº¿
    since := time.Now().Add(-5 * time.Minute)
    fills, _ := t.provider.GetFills(t.leaderID, since)
    for _, f := range fills {
        t.markSeen(f.ID)
    }
    
    for {
        select {
        case <-ctx.Done():
            return
        case <-t.stopCh:
            return
        case <-ticker.C:
            t.poll()
        }
    }
}

func (t *HyperliquidTracker) poll() {
    // è·å–æœ€è¿‘ 1 åˆ†é’Ÿçš„æˆäº¤
    since := time.Now().Add(-1 * time.Minute)
    fills, err := t.provider.GetFills(t.leaderID, since)
    if err != nil {
        logger.Warnf("âš ï¸ Failed to poll Hyperliquid fills: %v", err)
        return
    }
    
    // åŒæ­¥è´¦æˆ·çŠ¶æ€
    state, err := t.provider.GetAccountState(t.leaderID)
    if err != nil {
        logger.Warnf("âš ï¸ Failed to get leader state: %v", err)
    } else {
        t.lastState = state
        t.lastSync = time.Now()
    }
    
    // å¤„ç†æ–°æˆäº¤ï¼ˆæŒ‰æ—¶é—´æ’åºï¼Œç¡®ä¿åå‘å¼€ä»“æŒ‰é¡ºåºå¤„ç†ï¼‰
    sort.Slice(fills, func(i, j int) bool {
        return fills[i].Timestamp.Before(fills[j].Timestamp)
    })
    
    for _, fill := range fills {
        if t.isSeen(fill.ID) {
            continue
        }
        t.markSeen(fill.ID)
        
        // æ„é€ ä¿¡å·
        signal := &TradeSignal{
            LeaderID:     t.leaderID,
            ProviderType: "hyperliquid",
            Fill:         &fill,
            LeaderEquity: state.TotalEquity,
        }
        
        // é™„åŠ è¯¥å¸ç§çš„æŒä»“ä¿¡æ¯
        if pos, ok := state.Positions[fill.Symbol]; ok {
            signal.LeaderPosition = pos
        }
        
        // æ¨é€ä¿¡å·
        // ğŸ¯ åå‘å¼€ä»“å¤„ç†ï¼šHyperliquid ä¼šè¿”å›ä¸¤æ¡è®°å½•ï¼ˆå…ˆ Close å Openï¼‰
        // æŒ‰æ—¶é—´é¡ºåºæ¨é€ï¼ŒEngine ä¼šè‡ªåŠ¨æ ¹æ®æœ¬åœ°ä»“ä½åˆ¤æ–­æ˜¯å¦è·Ÿéš
        select {
        case t.signalCh <- signal:
            logger.Infof("ğŸ“¡ New signal: %s %s %s @ %.4f", 
                fill.Symbol, fill.Action, fill.PositionSide, fill.Price)
        default:
            logger.Warnf("âš ï¸ Signal channel full, dropping: %s", fill.ID)
        }
    }
}

// ğŸ¯ åå‘å¼€ä»“è¯´æ˜ï¼š
// Hyperliquid çš„åå‘å¼€ä»“åœ¨ API å±‚é¢ä¼šè¿”å›ä¸¤æ¡æˆäº¤è®°å½•ï¼š
// 1. Close Long/Short - å¹³æ‰åŸä»“ä½
// 2. Open Short/Long - å¼€æ–°æ–¹å‘ä»“ä½
//
// æˆ‘ä»¬ä¸éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œåªéœ€è¦ï¼š
// 1. æŒ‰æ—¶é—´é¡ºåºæ¨é€ä¿¡å·
// 2. Engine æ ¹æ®æœ¬åœ°ä»“ä½åˆ¤æ–­ï¼š
//    - å¦‚æœæœ¬åœ°æœ‰è¯¥æ–¹å‘ä»“ä½ â†’ æ‰§è¡Œå¹³ä»“
//    - å¦‚æœæœ¬åœ°æ— è¯¥æ–¹å‘ä»“ä½ â†’ å¿½ç•¥å¹³ä»“ï¼ˆå†å²ä»“ä½ï¼‰
//    - æ–°æ–¹å‘å¼€ä»“ â†’ å½“ä½œæ–°å¼€ä»“å¤„ç†

func (t *HyperliquidTracker) isSeen(id string) bool {
    t.seenMu.RLock()
    defer t.seenMu.RUnlock()
    return t.seenFills[id]
}

func (t *HyperliquidTracker) markSeen(id string) {
    t.seenMu.Lock()
    defer t.seenMu.Unlock()
    t.seenFills[id] = true
    
    // ä¿ç•™æœ€è¿‘ 10000 æ¡å»é‡è®°å½•
    if len(t.seenFills) > 10000 {
        // ç®€å•æ¸…ç†ï¼šåˆ é™¤ä¸€åŠ
        count := 0
        for k := range t.seenFills {
            delete(t.seenFills, k)
            count++
            if count >= 5000 {
                break
            }
        }
    }
}
```

### 4.3 Engine æ¨¡å— (è·Ÿå•å¼•æ“)

#### 4.3.1 æ ¸å¿ƒå¼•æ“

```go
// copytrade/engine/engine.go

package engine

import (
    "context"
    "fmt"
    "sync"
    "time"
    
    "nofx/copytrade/config"
    "nofx/copytrade/tracker"
    "nofx/decision"
    "nofx/logger"
    "nofx/store"
)

// CopyTradeEngine è·Ÿå•å¼•æ“
type CopyTradeEngine struct {
    traderID     string
    config       *config.CopyTradeConfig
    tracker      tracker.LeaderTracker
    
    // è·Ÿéšè€…è´¦æˆ·ä¿¡æ¯ (ç”±å¤–éƒ¨æ³¨å…¥)
    getFollowerEquity func() float64
    
    // å†³ç­–è¾“å‡º
    decisionCh   chan *decision.FullDecision
    
    // çŠ¶æ€
    running      bool
    mu           sync.RWMutex
    
    // ç»Ÿè®¡
    stats        *EngineStats
}

type EngineStats struct {
    SignalsReceived  int64
    DecisionsGenerated int64
    LastSignalTime   time.Time
}

func NewCopyTradeEngine(
    traderID string,
    cfg *config.CopyTradeConfig,
    getFollowerEquity func() float64,
) (*CopyTradeEngine, error) {
    // åˆ›å»º tracker
    var t tracker.LeaderTracker
    switch cfg.ProviderType {
    case "hyperliquid":
        t = tracker.NewHyperliquidTracker(cfg.LeaderID)
    case "okx":
        t = tracker.NewOKXTracker(cfg.LeaderID)
    default:
        return nil, fmt.Errorf("unsupported provider type: %s", cfg.ProviderType)
    }
    
    return &CopyTradeEngine{
        traderID:          traderID,
        config:            cfg,
        tracker:           t,
        getFollowerEquity: getFollowerEquity,
        decisionCh:        make(chan *decision.FullDecision, 10),
        stats:             &EngineStats{},
    }, nil
}

// Start å¯åŠ¨å¼•æ“
func (e *CopyTradeEngine) Start(ctx context.Context) error {
    e.mu.Lock()
    if e.running {
        e.mu.Unlock()
        return fmt.Errorf("engine already running")
    }
    e.running = true
    e.mu.Unlock()
    
    // å¯åŠ¨ tracker
    if err := e.tracker.Start(ctx); err != nil {
        return err
    }
    
    // å¯åŠ¨ä¿¡å·å¤„ç†åç¨‹
    go e.processSignals(ctx)
    
    logger.Infof("ğŸš€ CopyTrade engine started for trader %s", e.traderID)
    return nil
}

// Stop åœæ­¢å¼•æ“
func (e *CopyTradeEngine) Stop() {
    e.mu.Lock()
    defer e.mu.Unlock()
    
    if !e.running {
        return
    }
    
    e.tracker.Stop()
    e.running = false
    close(e.decisionCh)
    
    logger.Infof("ğŸ›‘ CopyTrade engine stopped for trader %s", e.traderID)
}

// GetDecisionChannel è·å–å†³ç­–è¾“å‡ºé€šé“
func (e *CopyTradeEngine) GetDecisionChannel() <-chan *decision.FullDecision {
    return e.decisionCh
}

// processSignals å¤„ç†äº¤æ˜“ä¿¡å·
func (e *CopyTradeEngine) processSignals(ctx context.Context) {
    signals := e.tracker.Subscribe()
    
    for {
        select {
        case <-ctx.Done():
            return
        case signal, ok := <-signals:
            if !ok {
                return
            }
            
            e.stats.SignalsReceived++
            e.stats.LastSignalTime = time.Now()
            
            // å¤„ç†ä¿¡å·
            dec, err := e.processSignal(signal)
            if err != nil {
                logger.Warnf("âš ï¸ Failed to process signal: %v", err)
                continue
            }
            
            if dec != nil {
                e.stats.DecisionsGenerated++
                
                // æ¨é€å†³ç­–
                select {
                case e.decisionCh <- dec:
                default:
                    logger.Warnf("âš ï¸ Decision channel full, dropping")
                }
            }
        }
    }
}

// processSignal å¤„ç†å•ä¸ªä¿¡å·ï¼Œç”Ÿæˆå†³ç­–
func (e *CopyTradeEngine) processSignal(signal *tracker.TradeSignal) (*decision.FullDecision, error) {
    fill := signal.Fill
    cfg := e.config
    
    // 1. ğŸ¯ æ ¸å¿ƒè§„åˆ™ï¼šåªè·Ÿæ–°å¼€ä»“ï¼ˆæœ¬åœ°ä»“ä½å¯¹æ¯”æ³•ï¼‰
    follow, reason := e.shouldFollowSignal(signal)
    if !follow {
        logger.Infof("ğŸ“‹ è·³è¿‡ä¿¡å·: %s | %s %s %s", reason, fill.Symbol, fill.Action, fill.PositionSide)
        return nil, nil
    }
    logger.Infof("âœ… è·Ÿéšä¿¡å·: %s | %s %s %s", reason, fill.Symbol, fill.Action, fill.PositionSide)
    
    // 2. è®¡ç®—è·Ÿå•ä»“ä½ï¼ˆå¸¦é¢„è­¦ï¼Œä¸é™åˆ¶ï¼‰
    copySize, warnings := e.calculateCopySizeWithWarnings(signal)
    
    // 3. è®°å½•æ‰€æœ‰é¢„è­¦ï¼ˆä¸é˜»æ­¢äº¤æ˜“ï¼‰
    for _, w := range warnings {
        e.warningLogger.Log(w)
    }
    
    // 4. æ„é€  Decisionï¼ˆæ— è®ºé¢„è­¦å¤šå°‘éƒ½æ‰§è¡Œï¼‰
    dec := e.buildDecision(signal, copySize)
    
    // 5. åŒ…è£…ä¸º FullDecision
    fullDec := &decision.FullDecision{
        SystemPrompt:        e.buildSystemPromptLog(),
        UserPrompt:          e.buildUserPromptLog(signal),
        CoTTrace:            e.buildCoTTrace(signal, copySize, warnings),
        Decisions:           []decision.Decision{dec},
        RawResponse:         fmt.Sprintf("Copy trade signal from %s:%s", cfg.ProviderType, cfg.LeaderID),
        Timestamp:           time.Now(),
        AIRequestDurationMs: 0, // è·Ÿå•æ—  AI è°ƒç”¨
        Warnings:            warnings, // æ–°å¢ï¼šé¢„è­¦åˆ—è¡¨
    }
    
    return fullDec, nil
}

// shouldFollowSignal ğŸ¯ æ ¸å¿ƒï¼šåˆ¤æ–­æ˜¯å¦åº”è¯¥è·Ÿéšè¯¥ä¿¡å·ï¼ˆåªè·Ÿæ–°å¼€ä»“åŸåˆ™ï¼‰
func (e *CopyTradeEngine) shouldFollowSignal(signal *tracker.TradeSignal) (follow bool, reason string) {
    fill := signal.Fill
    
    // è·å–æœ¬åœ°ä»“ä½
    localPosition := e.getLocalPosition(fill.Symbol, fill.PositionSide)
    hasLocalPosition := localPosition != nil && localPosition.Size > 0
    
    switch fill.Action {
    case "open":
        if !hasLocalPosition {
            // æœ¬åœ°æ— ä»“ä½ + é¢†èˆªå‘˜å¼€ä»“ = æ–°å¼€ä»“ï¼ˆè·Ÿï¼ï¼‰
            return true, "æ–°å¼€ä»“ä¿¡å·ï¼Œæœ¬åœ°æ— æŒä»“"
        } else {
            // æœ¬åœ°æœ‰ä»“ä½ + é¢†èˆªå‘˜"å¼€ä»“" = å…¶å®æ˜¯åŠ ä»“ï¼ˆè·Ÿï¼æ˜¯æˆ‘ä»¬è·Ÿè¿‡çš„ä»“ä½ï¼‰
            return true, "åŠ ä»“ä¿¡å·ï¼Œè·Ÿéšå·²æœ‰ä»“ä½"
        }
        
    case "add":
        if !hasLocalPosition {
            // æœ¬åœ°æ— ä»“ä½ + é¢†èˆªå‘˜åŠ ä»“ = å†å²ä»“ä½çš„åŠ ä»“ï¼ˆä¸è·Ÿï¼ï¼‰
            return false, "å¿½ç•¥ï¼šé¢†èˆªå‘˜å†å²ä»“ä½åŠ ä»“ï¼Œæˆ‘ä»¬æœªè·Ÿéšè¯¥ä»“ä½"
        }
        // æœ¬åœ°æœ‰ä»“ä½ = æ˜¯æˆ‘ä»¬è·Ÿè¿‡çš„ï¼ˆè·Ÿï¼ï¼‰
        return true, "åŠ ä»“ä¿¡å·ï¼Œè·Ÿéšå·²æœ‰ä»“ä½"
        
    case "reduce":
        if !hasLocalPosition {
            // æœ¬åœ°æ— ä»“ä½ + é¢†èˆªå‘˜å‡ä»“ = å†å²ä»“ä½çš„å‡ä»“ï¼ˆä¸è·Ÿï¼ï¼‰
            return false, "å¿½ç•¥ï¼šé¢†èˆªå‘˜å†å²ä»“ä½å‡ä»“ï¼Œæˆ‘ä»¬æœªè·Ÿéšè¯¥ä»“ä½"
        }
        // æœ¬åœ°æœ‰ä»“ä½ = æ˜¯æˆ‘ä»¬è·Ÿè¿‡çš„ï¼ˆè·Ÿï¼ï¼‰
        return true, "å‡ä»“ä¿¡å·ï¼Œè·Ÿéšå·²æœ‰ä»“ä½"
        
    case "close":
        if !hasLocalPosition {
            // æœ¬åœ°æ— ä»“ä½ + é¢†èˆªå‘˜å¹³ä»“ = å†å²ä»“ä½çš„å¹³ä»“ï¼ˆä¸è·Ÿï¼ï¼‰
            // è¿™ä¹Ÿå¤„ç†äº†åå‘å¼€ä»“çš„"å¹³ä»“éƒ¨åˆ†"ï¼šå¦‚æœæˆ‘ä»¬æ²¡æœ‰è¯¥ä»“ä½ï¼Œç›´æ¥å¿½ç•¥
            return false, "å¿½ç•¥ï¼šé¢†èˆªå‘˜å†å²ä»“ä½å¹³ä»“ï¼Œæˆ‘ä»¬æœªè·Ÿéšè¯¥ä»“ä½"
        }
        // æœ¬åœ°æœ‰ä»“ä½ = æ˜¯æˆ‘ä»¬è·Ÿè¿‡çš„ï¼ˆè·Ÿï¼ï¼‰
        return true, "å¹³ä»“ä¿¡å·ï¼Œè·Ÿéšå·²æœ‰ä»“ä½"
        
    default:
        return false, fmt.Sprintf("æœªçŸ¥æ“ä½œç±»å‹: %s", fill.Action)
    }
}

// getLocalPosition è·å–æœ¬åœ°ä»“ä½
func (e *CopyTradeEngine) getLocalPosition(symbol, side string) *Position {
    // è°ƒç”¨ç°æœ‰ç³»ç»Ÿçš„ä»“ä½æŸ¥è¯¢æ¥å£
    positions := e.followerTrader.GetPositions()
    
    for _, pos := range positions {
        if pos.Symbol == symbol && pos.Side == side {
            return pos
        }
    }
    return nil
}

// determineCloseAction åˆ¤æ–­æ˜¯å‡ä»“è¿˜æ˜¯å¹³ä»“ï¼ˆé€šè¿‡é¢†èˆªå‘˜å®æ—¶æŒä»“åˆ¤æ–­ï¼‰
func (e *CopyTradeEngine) determineCloseAction(signal *tracker.TradeSignal) string {
    // è·å–é¢†èˆªå‘˜è¯¥å¸ç§çš„å½“å‰æŒä»“
    leaderPosition := signal.LeaderPosition
    
    if leaderPosition == nil || leaderPosition.Size == 0 {
        // é¢†èˆªå‘˜è¯¥å¸ç§ä»“ä½å·²æ¸…é›¶ = å¹³ä»“
        return "close"
    }
    // é¢†èˆªå‘˜è¯¥å¸ç§ä»“ä½ä»æœ‰ = å‡ä»“
    return "reduce"
}

// calculateReduceRatio è®¡ç®—å‡ä»“æ¯”ä¾‹ï¼ˆç”¨äºéƒ¨åˆ†å¹³ä»“ï¼‰
func (e *CopyTradeEngine) calculateReduceRatio(signal *tracker.TradeSignal) float64 {
    // é¢†èˆªå‘˜æœ¬æ¬¡å‡ä»“æ•°é‡
    reduceSize := signal.Fill.Size
    
    // é¢†èˆªå‘˜å‡ä»“å‰çš„æŒä»“ = å½“å‰æŒä»“ + æœ¬æ¬¡å‡ä»“é‡
    leaderCurrentSize := float64(0)
    if signal.LeaderPosition != nil {
        leaderCurrentSize = signal.LeaderPosition.Size
    }
    leaderPreviousSize := leaderCurrentSize + reduceSize
    
    if leaderPreviousSize <= 0 {
        return 1.0 // å…¨éƒ¨å¹³ä»“
    }
    
    // å‡ä»“æ¯”ä¾‹ = å‡ä»“é‡ / å‡ä»“å‰æŒä»“
    ratio := reduceSize / leaderPreviousSize
    
    logger.Debugf("ğŸ“Š å‡ä»“æ¯”ä¾‹è®¡ç®—: å‡ä»“é‡=%.4f, å‡ä»“å‰æŒä»“=%.4f, æ¯”ä¾‹=%.2f%%",
        reduceSize, leaderPreviousSize, ratio*100)
    
    return ratio
}
```

#### 4.3.2 æ¯”ä¾‹è®¡ç®—å™¨

```go
// copytrade/engine/ratio.go

package engine

import (
    "nofx/copytrade/tracker"
)

// calculateCopySize è®¡ç®—è·Ÿå•ä»“ä½å¤§å°
// å…¬å¼: ä½ çš„å¼€ä»“é‡‘é¢ = è·Ÿå•æ¯”ä¾‹ Ã— (äº¤æ˜“å‘˜å¼€ä»“é‡‘é¢ Ã· äº¤æ˜“å‘˜è´¦æˆ·ä½™é¢) Ã— ä½ çš„è´¦æˆ·ä½™é¢
func (e *CopyTradeEngine) calculateCopySize(signal *tracker.TradeSignal) (float64, error) {
    cfg := e.config
    fill := signal.Fill
    
    // é¢†èˆªå‘˜çš„æˆäº¤ä»·å€¼
    leaderTradeValue := fill.Value
    
    // é¢†èˆªå‘˜çš„è´¦æˆ·æƒç›Š
    leaderEquity := signal.LeaderEquity
    if leaderEquity <= 0 {
        leaderEquity = 1 // é˜²æ­¢é™¤é›¶
    }
    
    // é¢†èˆªå‘˜è¯¥ç¬”äº¤æ˜“å å…¶è´¦æˆ·çš„æ¯”ä¾‹
    leaderTradeRatio := leaderTradeValue / leaderEquity
    
    // è·Ÿéšè€…è´¦æˆ·æƒç›Š
    followerEquity := e.getFollowerEquity()
    if followerEquity <= 0 {
        return 0, fmt.Errorf("follower equity is zero")
    }
    
    // è®¡ç®—è·Ÿå•é‡‘é¢
    // copySize = copyRatio Ã— leaderTradeRatio Ã— followerEquity
    copySize := cfg.CopyRatio * leaderTradeRatio * followerEquity
    
    logger.Debugf("ğŸ“Š Copy ratio calculation: "+
        "leaderTrade=%.2f, leaderEquity=%.2f (ratio=%.4f), "+
        "followerEquity=%.2f, copyRatio=%.2f â†’ copySize=%.2f",
        leaderTradeValue, leaderEquity, leaderTradeRatio,
        followerEquity, cfg.CopyRatio, copySize)
    
    return copySize, nil
}
```

#### 4.3.3 Decision é€‚é…å™¨

```go
// copytrade/engine/adapter.go

package engine

import (
    "fmt"
    "time"
    
    "nofx/copytrade/tracker"
    "nofx/decision"
)

// buildDecision æ„é€ ç¬¦åˆç°æœ‰æ ¼å¼çš„ Decision
func (e *CopyTradeEngine) buildDecision(signal *tracker.TradeSignal, copySize float64) decision.Decision {
    fill := signal.Fill
    cfg := e.config
    
    // åˆ¤æ–­å®é™…æ“ä½œç±»å‹ï¼ˆç‰¹åˆ«æ˜¯å‡ä»“ vs å¹³ä»“ï¼‰
    actualAction := fill.Action
    if fill.Action == "close" || fill.Action == "reduce" {
        // é€šè¿‡é¢†èˆªå‘˜å®æ—¶æŒä»“åˆ¤æ–­æ˜¯å‡ä»“è¿˜æ˜¯å¹³ä»“
        actualAction = e.determineCloseAction(signal)
    }
    
    // æ˜ å°„ action åˆ°ç°æœ‰æ ¼å¼
    action := e.mapAction(actualAction, fill.PositionSide)
    
    dec := decision.Decision{
        Symbol:    fill.Symbol,
        Action:    action,
        Reasoning: fmt.Sprintf("Copy trading: following %s leader %s (%s)", 
            cfg.ProviderType, cfg.LeaderID, actualAction),
    }
    
    // å¼€ä»“/åŠ ä»“éœ€è¦é¢å¤–å‚æ•°
    if action == "open_long" || action == "open_short" {
        dec.PositionSizeUSD = copySize
        
        // æ æ†ï¼šåŒæ­¥é¢†èˆªå‘˜æˆ–ä½¿ç”¨é»˜è®¤
        if cfg.SyncLeverage && signal.LeaderPosition != nil {
            dec.Leverage = signal.LeaderPosition.Leverage
        } else {
            dec.Leverage = 5 // é»˜è®¤æ æ†
        }
        
        // æ­¢æŸæ­¢ç›ˆï¼šè·Ÿå•æ¨¡å¼ä¸‹å¯é€‰è®¾ç½®
        if fill.PositionSide == "long" {
            dec.StopLoss = fill.Price * 0.97
            dec.TakeProfit = fill.Price * 1.09
        } else {
            dec.StopLoss = fill.Price * 1.03
            dec.TakeProfit = fill.Price * 0.91
        }
        
        dec.Confidence = 90
    }
    
    // å‡ä»“éœ€è¦æŒ‡å®šå‡ä»“æ¯”ä¾‹
    if actualAction == "reduce" {
        dec.ReduceRatio = e.calculateReduceRatio(signal)
        dec.Reasoning = fmt.Sprintf("Copy trading: reduce %.0f%% following %s leader %s",
            dec.ReduceRatio*100, cfg.ProviderType, cfg.LeaderID)
    }
    
    // å¹³ä»“
    if actualAction == "close" {
        dec.Reasoning = fmt.Sprintf("Copy trading: close position following %s leader %s",
            cfg.ProviderType, cfg.LeaderID)
    }
    
    return dec
}

// mapAction æ˜ å°„æ“ä½œç±»å‹åˆ°ç°æœ‰ decision æ ¼å¼
func (e *CopyTradeEngine) mapAction(action, posSide string) string {
    switch {
    case action == "open" && posSide == "long":
        return "open_long"
    case action == "open" && posSide == "short":
        return "open_short"
    case action == "close" && posSide == "long":
        return "close_long"
    case action == "close" && posSide == "short":
        return "close_short"
    case action == "add" && posSide == "long":
        return "open_long" // åŠ ä»“è§†ä¸ºå¢åŠ å¼€ä»“
    case action == "add" && posSide == "short":
        return "open_short"
    case action == "reduce" && posSide == "long":
        return "reduce_long" // å‡ä»“ï¼ˆéƒ¨åˆ†å¹³ä»“ï¼‰
    case action == "reduce" && posSide == "short":
        return "reduce_short"
    default:
        return "hold"
    }
}

// buildCoTTrace æ„å»º Chain of Thought æ—¥å¿— (å…¼å®¹ AI æ ¼å¼)
func (e *CopyTradeEngine) buildCoTTrace(signal *tracker.TradeSignal, copySize float64, warnings []Warning) string {
    fill := signal.Fill
    cfg := e.config
    
    // æ„å»ºé¢„è­¦éƒ¨åˆ†
    warningSection := ""
    if len(warnings) > 0 {
        warningSection = "\n## âš ï¸ Warnings (Not Blocking)\n"
        for _, w := range warnings {
            warningSection += fmt.Sprintf("- [%s] %s\n", w.Type, w.Message)
        }
        warningSection += "\n**Note: All warnings are for logging only. Trade will be executed.**\n"
    }
    
    return fmt.Sprintf(`# Copy Trading Decision Analysis

## Signal Source
- Provider: %s
- Leader: %s
- Signal Time: %s

## Leader Trade Details
- Symbol: %s
- Action: %s %s
- Price: %.4f
- Size: %.4f
- Value: %.2f USDT

## Leader Account State
- Total Equity: %.2f USDT
- Trade/Equity Ratio: %.4f%%

## Copy Calculation
- Copy Ratio Setting: %.0f%%
- Follower Equity: %.2f USDT
- Calculated Copy Size: %.2f USDT
%s
## Decision
Following the leader's %s %s action on %s.
Trade will be executed unconditionally (warnings are for logging only).
`,
        cfg.ProviderType,
        cfg.LeaderID,
        fill.Timestamp.Format("2006-01-02 15:04:05"),
        fill.Symbol,
        fill.Action,
        fill.PositionSide,
        fill.Price,
        fill.Size,
        fill.Value,
        signal.LeaderEquity,
        (fill.Value/signal.LeaderEquity)*100,
        cfg.CopyRatio*100,
        e.getFollowerEquity(),
        copySize,
        warningSection,
        fill.Action,
        fill.PositionSide,
        fill.Symbol,
    )
}

// buildSystemPromptLog æ„å»º SystemPrompt æ—¥å¿—
func (e *CopyTradeEngine) buildSystemPromptLog() string {
    return fmt.Sprintf(`# Copy Trading Mode

You are operating in Copy Trading mode, following a human leader's trades.

## Provider: %s
## Leader ID: %s
## Copy Ratio: %.0f%%

## Core Rules:
- **Only follow new positions**: Only copy trades for positions we've opened (not leader's historical positions)
- **Unconditional execution**: All leader's actions for tracked positions will be executed
- **Warning mode**: Risk limits only generate warnings, never block trades

## Position Tracking:
- New open: If we have no local position â†’ follow as new position
- Add/Reduce/Close: If we have local position â†’ follow (it's our tracked position)
- Add/Reduce/Close: If we have no local position â†’ skip (leader's historical position)

## Sync Settings:
- Sync Leverage: %v
- Sync Margin Mode: %v
`,
        e.config.ProviderType,
        e.config.LeaderID,
        e.config.CopyRatio*100,
        e.config.SyncLeverage,
        e.config.SyncMarginMode,
    )
}

// buildUserPromptLog æ„å»º UserPrompt æ—¥å¿—
func (e *CopyTradeEngine) buildUserPromptLog(signal *tracker.TradeSignal) string {
    fill := signal.Fill
    
    return fmt.Sprintf(`## New Trade Signal Received

Time: %s
Symbol: %s
Action: %s %s
Price: %.4f
Size: %.4f (%.2f USDT)

Leader Position:
%s

Follower Equity: %.2f USDT
`,
        fill.Timestamp.Format("2006-01-02 15:04:05"),
        fill.Symbol,
        fill.Action,
        fill.PositionSide,
        fill.Price,
        fill.Size,
        fill.Value,
        formatPosition(signal.LeaderPosition),
        e.getFollowerEquity(),
    )
}
```

---

## 5. æ•°æ®æ¨¡å‹

### 5.1 æ•°æ®åº“è¡¨è®¾è®¡

> âš ï¸ **è®¾è®¡åŸåˆ™**ï¼šè·Ÿå•é…ç½®ç›´æ¥æ‰©å±•ç°æœ‰ `traders` è¡¨ï¼Œä¸å•ç‹¬å»ºè¡¨ã€‚

```sql
-- æ–¹æ¡ˆ Aï¼šæ‰©å±•ç°æœ‰ traders è¡¨ï¼ˆæ¨èï¼Œæ›´ç®€å•ï¼‰
ALTER TABLE traders ADD COLUMN decision_mode TEXT DEFAULT 'ai';  -- "ai" | "copy_trade"
ALTER TABLE traders ADD COLUMN copy_config TEXT;  -- JSON æ ¼å¼å­˜å‚¨è·Ÿå•é…ç½®

-- copy_config JSON ç»“æ„ï¼š
-- {
--   "provider_type": "hyperliquid",
--   "leader_id": "0x...",
--   "copy_ratio": 1.0,
--   "sync_leverage": true,
--   "sync_margin_mode": true
-- }
```

```sql
-- æ–¹æ¡ˆ Bï¼šå¦‚æœéœ€è¦å•ç‹¬è¡¨ï¼ˆå¯é€‰ï¼Œä¾¿äºæ‰©å±•ï¼‰
CREATE TABLE IF NOT EXISTS copy_trade_configs (
    trader_id TEXT PRIMARY KEY,        -- ç›´æ¥ç”¨ trader_id ä½œä¸ºä¸»é”®ï¼ˆ1:1 å…³ç³»ï¼‰
    provider_type TEXT NOT NULL,       -- "hyperliquid" | "okx"
    leader_id TEXT NOT NULL,           -- é¢†èˆªå‘˜åœ°å€/uniqueName
    copy_ratio REAL DEFAULT 1.0,       -- è·Ÿå•ç³»æ•° (1.0 = 100%)
    
    -- åŒæ­¥é€‰é¡¹
    sync_leverage BOOLEAN DEFAULT 1,
    sync_margin_mode BOOLEAN DEFAULT 1,
    
    -- çŠ¶æ€ç”± traders è¡¨çš„ decision_mode æ§åˆ¶ï¼Œè¿™é‡Œä¸éœ€è¦ enabled å­—æ®µ
    
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (trader_id) REFERENCES traders(id) ON DELETE CASCADE
);
-- æ³¨æ„ï¼šæ²¡æœ‰å•ç‹¬çš„ id å­—æ®µï¼Œtrader_id å°±æ˜¯ä¸»é”®ï¼Œå¼ºè°ƒ 1:1 å…³ç³»
```

-- è·Ÿå•ä¿¡å·æ—¥å¿—è¡¨
CREATE TABLE IF NOT EXISTS copy_trade_signals (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    trader_id TEXT NOT NULL,
    leader_id TEXT NOT NULL,
    provider_type TEXT NOT NULL,
    signal_id TEXT NOT NULL,           -- åŸå§‹ä¿¡å· ID
    symbol TEXT NOT NULL,
    action TEXT NOT NULL,
    position_side TEXT NOT NULL,       -- "long" | "short"
    leader_price REAL,
    leader_size REAL,
    leader_value REAL,
    copy_size REAL,                    -- è®¡ç®—åçš„è·Ÿå•å¤§å°
    
    -- è·Ÿå•åˆ¤æ–­
    followed BOOLEAN DEFAULT 0,        -- æ˜¯å¦è·Ÿéš
    follow_reason TEXT,                -- è·Ÿéš/å¿½ç•¥åŸå› 
    
    -- é¢„è­¦ä¿¡æ¯
    warnings_json TEXT,                -- é¢„è­¦åˆ—è¡¨ JSON
    
    -- æ‰§è¡ŒçŠ¶æ€
    decision_json TEXT,                -- ç”Ÿæˆçš„å†³ç­– JSON
    status TEXT DEFAULT 'pending',     -- pending | executed | failed | skipped
    error_message TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(trader_id, signal_id)
);

-- é¢„è­¦æ—¥å¿—è¡¨
CREATE TABLE IF NOT EXISTS copy_trade_warnings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    trader_id TEXT NOT NULL,
    leader_id TEXT NOT NULL,
    symbol TEXT NOT NULL,
    warning_type TEXT NOT NULL,        -- low_value | high_value | insufficient_balance | etc.
    message TEXT NOT NULL,
    signal_action TEXT,
    signal_value REAL,
    copy_value REAL,
    executed BOOLEAN DEFAULT 1,        -- é¢„è­¦ä¸é˜»æ­¢æ‰§è¡Œï¼Œå§‹ç»ˆä¸º true
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_warnings_trader ON copy_trade_warnings(trader_id);
CREATE INDEX idx_warnings_time ON copy_trade_warnings(created_at);
```

### 5.2 Go ç»“æ„å®šä¹‰

```go
// store/copytrade.go

package store

import (
    "database/sql"
    "time"
)

type CopyTradeConfig struct {
    ID               string    `json:"id"`
    TraderID         string    `json:"trader_id"`
    ProviderType     string    `json:"provider_type"`     // "hyperliquid" | "okx"
    LeaderID         string    `json:"leader_id"`
    CopyRatio        float64   `json:"copy_ratio"`        // 1.0 = 100%
    
    // é¢„è­¦é˜ˆå€¼ï¼ˆä¸é™åˆ¶ï¼Œåªé¢„è­¦ï¼‰
    MinTradeWarn     float64   `json:"min_trade_warn"`    // ä½äºæ­¤é‡‘é¢è®°å½•é¢„è­¦
    MaxTradeWarn     float64   `json:"max_trade_warn"`    // é«˜äºæ­¤é‡‘é¢è®°å½•é¢„è­¦
    
    // åŒæ­¥é€‰é¡¹
    SyncLeverage     bool      `json:"sync_leverage"`
    SyncMarginMode   bool      `json:"sync_margin_mode"`
    UseFallbackPrice bool      `json:"use_fallback_price"`
    
    Enabled          bool      `json:"enabled"`
    CreatedAt        time.Time `json:"created_at"`
    UpdatedAt        time.Time `json:"updated_at"`
    
    // âš ï¸ æ— æ¡ä»¶è·Ÿéšï¼šæ²¡æœ‰ FollowOpen/Add/Reduce/Close å­—æ®µ
    // æ‰€æœ‰è·Ÿéšçš„ä»“ä½çš„æ“ä½œéƒ½ä¼šæ‰§è¡Œ
}

// CopyTradeSignal è·Ÿå•ä¿¡å·è®°å½•
type CopyTradeSignal struct {
    ID            int64     `json:"id"`
    TraderID      string    `json:"trader_id"`
    LeaderID      string    `json:"leader_id"`
    ProviderType  string    `json:"provider_type"`
    SignalID      string    `json:"signal_id"`
    Symbol        string    `json:"symbol"`
    Action        string    `json:"action"`
    PositionSide  string    `json:"position_side"`
    LeaderPrice   float64   `json:"leader_price"`
    LeaderSize    float64   `json:"leader_size"`
    LeaderValue   float64   `json:"leader_value"`
    CopySize      float64   `json:"copy_size"`
    
    // è·Ÿå•åˆ¤æ–­
    Followed      bool      `json:"followed"`
    FollowReason  string    `json:"follow_reason"`
    
    // é¢„è­¦
    Warnings      []Warning `json:"warnings,omitempty"`
    
    // æ‰§è¡ŒçŠ¶æ€
    Decision      *Decision `json:"decision,omitempty"`
    Status        string    `json:"status"`
    ErrorMessage  string    `json:"error_message,omitempty"`
    CreatedAt     time.Time `json:"created_at"`
}

type CopyTradeStore struct {
    db *sql.DB
}

func (s *CopyTradeStore) Create(cfg *CopyTradeConfig) error { ... }
func (s *CopyTradeStore) Update(cfg *CopyTradeConfig) error { ... }
func (s *CopyTradeStore) Delete(id string) error { ... }
func (s *CopyTradeStore) GetByTraderID(traderID string) (*CopyTradeConfig, error) { ... }
func (s *CopyTradeStore) List(userID string) ([]*CopyTradeConfig, error) { ... }

// ä¿¡å·æ—¥å¿—
func (s *CopyTradeStore) SaveSignal(signal *CopyTradeSignal) error { ... }
func (s *CopyTradeStore) GetSignals(traderID string, limit int) ([]*CopyTradeSignal, error) { ... }

// é¢„è­¦æ—¥å¿—
func (s *CopyTradeStore) SaveWarning(warning *Warning) error { ... }
func (s *CopyTradeStore) GetWarnings(traderID string, limit int) ([]*Warning, error) { ... }
```

---

## 6. API è®¾è®¡

### 6.1 è·Ÿå•é…ç½® API

```
# è·å–è·Ÿå•é…ç½®
GET /api/traders/:id/copy-config
Response: CopyTradeConfig

# åˆ›å»º/æ›´æ–°è·Ÿå•é…ç½®
PUT /api/traders/:id/copy-config
Body: {
    "provider_type": "hyperliquid",
    "leader_id": "0x123...",
    "copy_ratio": 1.0,              // è·Ÿå•ç³»æ•° (1.0 = 100%)
    "min_trade_warn": 10,           // é¢„è­¦é˜ˆå€¼ï¼šä½äºæ­¤é‡‘é¢è®°å½•é¢„è­¦
    "max_trade_warn": 0,            // é¢„è­¦é˜ˆå€¼ï¼šé«˜äºæ­¤é‡‘é¢è®°å½•é¢„è­¦ (0=ä¸é¢„è­¦)
    "sync_leverage": true,          // åŒæ­¥æ æ†
    "sync_margin_mode": true,       // åŒæ­¥ä¿è¯é‡‘æ¨¡å¼
    "use_fallback_price": true,     // ç¼ºä»·ä½¿ç”¨è¡Œæƒ…å…œåº•
    "enabled": true
}
// âš ï¸ æ³¨æ„ï¼šæ²¡æœ‰ follow_open/add/reduce/close é€‰é¡¹
// ç³»ç»Ÿä¼šæ— æ¡ä»¶è·Ÿéšæ‰€æœ‰æ“ä½œ

# åˆ é™¤è·Ÿå•é…ç½® (æ¢å¤ä¸º AI æ¨¡å¼)
DELETE /api/traders/:id/copy-config

# è·å–é¢†èˆªå‘˜ä¿¡æ¯ (é¢„è§ˆ)
GET /api/copy-trade/leader-info?provider=hyperliquid&leader_id=0x123...
Response: {
    "provider": "hyperliquid",
    "leader_id": "0x123...",
    "total_equity": 50000.00,
    "positions": [...],
    "recent_trades": [...]
}

# è·å–è·Ÿå•ä¿¡å·æ—¥å¿—
GET /api/traders/:id/copy-signals?limit=50
Response: {
    "signals": [
        {
            "signal_id": "536939280839171",
            "symbol": "BTCUSDT",
            "action": "open",
            "position_side": "long",
            "followed": true,
            "follow_reason": "æ–°å¼€ä»“ä¿¡å·ï¼Œæœ¬åœ°æ— æŒä»“",
            "warnings": [],
            "status": "executed"
        }
    ]
}

# è·å–é¢„è­¦æ—¥å¿—
GET /api/traders/:id/copy-warnings?limit=50
Response: {
    "warnings": [
        {
            "type": "high_value",
            "symbol": "BTCUSDT",
            "message": "è·Ÿå•é‡‘é¢è¾ƒå¤§ (5000 USDT)ï¼Œä»æ‰§è¡Œ",
            "executed": true,
            "created_at": "2025-12-16T14:30:00Z"
        }
    ]
}
```

### 6.2 API Handler

```go
// api/copytrade_handler.go

package api

import (
    "net/http"
    
    "github.com/gin-gonic/gin"
    "nofx/copytrade/provider"
    "nofx/store"
)

type CopyTradeHandler struct {
    store *store.Store
}

// HandleGetCopyConfig è·å–è·Ÿå•é…ç½®
func (h *CopyTradeHandler) HandleGetCopyConfig(c *gin.Context) {
    traderID := c.Param("id")
    userID := c.GetString("user_id")
    
    // éªŒè¯ trader å½’å±
    trader, err := h.store.Trader().GetFullConfig(userID, traderID)
    if err != nil {
        c.JSON(http.StatusNotFound, gin.H{"error": "Trader not found"})
        return
    }
    
    config, err := h.store.CopyTrade().GetByTraderID(traderID)
    if err != nil {
        c.JSON(http.StatusOK, gin.H{"enabled": false})
        return
    }
    
    c.JSON(http.StatusOK, config)
}

// HandleUpdateCopyConfig åˆ›å»º/æ›´æ–°è·Ÿå•é…ç½®
func (h *CopyTradeHandler) HandleUpdateCopyConfig(c *gin.Context) {
    traderID := c.Param("id")
    userID := c.GetString("user_id")
    
    var req store.CopyTradeConfig
    if err := c.ShouldBindJSON(&req); err != nil {
        c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
        return
    }
    
    // éªŒè¯ trader å½’å±
    if _, err := h.store.Trader().GetFullConfig(userID, traderID); err != nil {
        c.JSON(http.StatusNotFound, gin.H{"error": "Trader not found"})
        return
    }
    
    // éªŒè¯ provider_type
    if req.ProviderType != "hyperliquid" && req.ProviderType != "okx" {
        c.JSON(http.StatusBadRequest, gin.H{"error": "Invalid provider type"})
        return
    }
    
    req.TraderID = traderID
    
    // åˆ›å»ºæˆ–æ›´æ–°
    existing, _ := h.store.CopyTrade().GetByTraderID(traderID)
    if existing != nil {
        req.ID = existing.ID
        if err := h.store.CopyTrade().Update(&req); err != nil {
            c.JSON(http.StatusInternalServerError, gin.H{"error": err.Error()})
            return
        }
    } else {
        req.ID = generateID()
        if err := h.store.CopyTrade().Create(&req); err != nil {
            c.JSON(http.StatusInternalServerError, gin.H{"error": err.Error()})
            return
        }
    }
    
    // é‡æ–°åŠ è½½ trader (è§¦å‘å¼•æ“åˆ‡æ¢)
    h.reloadTrader(traderID)
    
    c.JSON(http.StatusOK, gin.H{"message": "Copy trade config updated"})
}

// HandleGetLeaderInfo è·å–é¢†èˆªå‘˜ä¿¡æ¯
func (h *CopyTradeHandler) HandleGetLeaderInfo(c *gin.Context) {
    providerType := c.Query("provider")
    leaderID := c.Query("leader_id")
    
    var p provider.LeaderProvider
    switch providerType {
    case "hyperliquid":
        p = provider.NewHyperliquidProvider()
    case "okx":
        p = provider.NewOKXProvider()
    default:
        c.JSON(http.StatusBadRequest, gin.H{"error": "Invalid provider"})
        return
    }
    
    state, err := p.GetAccountState(leaderID)
    if err != nil {
        c.JSON(http.StatusBadRequest, gin.H{"error": "Failed to fetch leader info: " + err.Error()})
        return
    }
    
    c.JSON(http.StatusOK, gin.H{
        "provider":      providerType,
        "leader_id":     leaderID,
        "total_equity":  state.TotalEquity,
        "positions":     state.Positions,
    })
}
```

---

## 7. è·Ÿå•æ¯”ä¾‹ç®—æ³•

### 7.1 æ ¸å¿ƒå…¬å¼

```
ä½ çš„å¼€ä»“é‡‘é¢ = è·Ÿå•æ¯”ä¾‹ Ã— (äº¤æ˜“å‘˜å¼€ä»“é‡‘é¢ Ã· äº¤æ˜“å‘˜è´¦æˆ·ä½™é¢) Ã— ä½ çš„è´¦æˆ·ä½™é¢
```

### 7.2 è®¡ç®—ç¤ºä¾‹

| å‚æ•° | å€¼ |
|------|-----|
| é¢†èˆªå‘˜è´¦æˆ·ä½™é¢ | 100,000 USDT |
| é¢†èˆªå‘˜å¼€ä»“é‡‘é¢ | 10,000 USDT |
| é¢†èˆªå‘˜ä»“ä½æ¯”ä¾‹ | 10% |
| ä½ çš„è´¦æˆ·ä½™é¢ | 1,000 USDT |
| è·Ÿå•ç³»æ•° | 100% (1.0) |
| **ä½ çš„å¼€ä»“é‡‘é¢** | **1.0 Ã— 10% Ã— 1,000 = 100 USDT** |

### 7.3 è·Ÿå•ç³»æ•°è¯´æ˜

| ç³»æ•° | å«ä¹‰ | ç¤ºä¾‹ (é¢†èˆªå‘˜ 10%ï¼Œä½ ä½™é¢ 1000) |
|------|------|------|
| 50% | å‡åŠè·Ÿéš | 50 USDT |
| 100% | å®Œå…¨å¤åˆ¶ | 100 USDT |
| 200% | åŒå€è·Ÿéš | 200 USDT |

### 7.4 è¾¹ç•Œå¤„ç†ï¼ˆé¢„è­¦æ¨¡å¼ï¼‰

```go
// æ³¨æ„ï¼šæ–°è®¾è®¡ä¸­ä¸é™åˆ¶äº¤æ˜“ï¼Œåªåšé¢„è­¦æ—¥å¿—
func (e *CopyTradeEngine) calculateCopySize(signal *TradeSignal) (float64, []Warning) {
    cfg := e.config
    var warnings []Warning
    
    // åŸºç¡€è®¡ç®—
    leaderRatio := signal.Fill.Value / signal.LeaderEquity
    followerEquity := e.getFollowerEquity()
    copySize := cfg.CopyRatio * leaderRatio * followerEquity
    
    // æœ€å°é‡‘é¢é¢„è­¦ï¼ˆä¸é˜»æ­¢ï¼Œåªè®°å½•ï¼‰
    if copySize < cfg.MinTradeSize {
        warnings = append(warnings, Warning{
            Type:    "low_value",
            Message: fmt.Sprintf("è·Ÿå•é‡‘é¢è¾ƒå° (%.2f USDT)ï¼Œä»æ‰§è¡Œ", copySize),
        })
        // ä¸è¿”å› 0ï¼Œç»§ç»­æ‰§è¡Œï¼
    }
    
    // æœ€å¤§é‡‘é¢é¢„è­¦ï¼ˆä¸æˆªæ–­ï¼Œåªè®°å½•ï¼‰
    if cfg.MaxTradeSize > 0 && copySize > cfg.MaxTradeSize {
        warnings = append(warnings, Warning{
            Type:    "high_value",
            Message: fmt.Sprintf("è·Ÿå•é‡‘é¢è¾ƒå¤§ (%.2f USDT > %.2f ä¸Šé™)ï¼Œä»æŒ‰åŸé‡‘é¢æ‰§è¡Œ", copySize, cfg.MaxTradeSize),
        })
        // ä¸æˆªæ–­ï¼ŒæŒ‰åŸé‡‘é¢æ‰§è¡Œï¼
    }
    
    // å¯ç”¨ä½™é¢ä¸è¶³é¢„è­¦ï¼ˆå°½é‡æ‰§è¡Œï¼‰
    availableBalance := e.getFollowerAvailableBalance()
    if copySize > availableBalance {
        warnings = append(warnings, Warning{
            Type:    "insufficient_balance",
            Message: fmt.Sprintf("ä½™é¢ä¸è¶³ (éœ€ %.2f, å¯ç”¨ %.2f)ï¼Œä»¥æœ€å¤§å¯ç”¨æ‰§è¡Œ", copySize, availableBalance),
        })
        copySize = availableBalance // è¿™æ˜¯å”¯ä¸€çš„è°ƒæ•´ï¼šç”¨å°½å¯ç”¨ä½™é¢
    }
    
    return copySize, warnings
}
```

---

## 8. å‰ç«¯é›†æˆ

### 8.1 ç±»å‹å®šä¹‰

```typescript
// web/src/types.ts (æ–°å¢)

export interface CopyTradeConfig {
  id: string;
  trader_id: string;
  provider_type: 'hyperliquid' | 'okx';
  leader_id: string;
  copy_ratio: number;        // 1.0 = 100%
  
  // é¢„è­¦é˜ˆå€¼ï¼ˆä¸é™åˆ¶äº¤æ˜“ï¼‰
  min_trade_warn: number;    // ä½äºæ­¤é‡‘é¢è®°å½•é¢„è­¦
  max_trade_warn: number;    // é«˜äºæ­¤é‡‘é¢è®°å½•é¢„è­¦ (0=ä¸é¢„è­¦)
  
  // åŒæ­¥é€‰é¡¹
  sync_leverage: boolean;
  sync_margin_mode: boolean;
  use_fallback_price: boolean;
  
  enabled: boolean;
  
  // âš ï¸ æ— æ¡ä»¶è·Ÿéšï¼šæ²¡æœ‰ follow_open/add/reduce/close é€‰é¡¹
}

export interface LeaderInfo {
  provider: string;
  leader_id: string;
  total_equity: number;
  positions: Position[];
  recent_trades: LeaderTrade[];
}

export interface LeaderTrade {
  id: string;
  symbol: string;
  action: 'open' | 'close' | 'add' | 'reduce';
  position_side: 'long' | 'short';
  price: number;
  size: number;
  value: number;
  timestamp: string;
}

export interface CopyTradeSignal {
  signal_id: string;
  symbol: string;
  action: string;
  position_side: string;
  leader_price: number;
  leader_value: number;
  copy_size: number;
  followed: boolean;
  follow_reason: string;
  warnings: CopyTradeWarning[];
  status: 'pending' | 'executed' | 'failed' | 'skipped';
  created_at: string;
}

export interface CopyTradeWarning {
  type: 'low_value' | 'high_value' | 'insufficient_balance' | 'high_frequency' | 'high_leverage' | 'large_position_ratio';
  symbol: string;
  message: string;
  executed: boolean;
  created_at: string;
}
```

### 8.2 é…ç½®ç»„ä»¶

å‚è€ƒä½ æä¾›çš„ UI è®¾è®¡å›¾ï¼Œä¸»è¦åŒ…å«ï¼š

1. **Provider ç±»å‹é€‰æ‹©** - ä¸‹æ‹‰æ¡†ï¼šHyperliquid é’±åŒ… / OKX
2. **é’±åŒ…/é¢†èˆªå‘˜ ID** - è¾“å…¥æ¡†ï¼šåœ°å€æˆ– uniqueName
3. **è·Ÿå•ç³»æ•°** - æ•°å­—è¾“å…¥ï¼šç™¾åˆ†æ¯” (50%, 100%, 200% ç­‰)
4. **é¢„è­¦é˜ˆå€¼** - æ•°å­—è¾“å…¥ï¼ˆå¯é€‰ï¼‰ï¼š
   - å°é¢é¢„è­¦é˜ˆå€¼ï¼šä½äºæ­¤é‡‘é¢è®°å½•é¢„è­¦æ—¥å¿—
   - å¤§é¢é¢„è­¦é˜ˆå€¼ï¼šé«˜äºæ­¤é‡‘é¢è®°å½•é¢„è­¦æ—¥å¿—
5. **åŒæ­¥é€‰é¡¹** - å¤é€‰æ¡†ç»„ï¼š
   - åŒæ­¥æ æ†
   - åŒæ­¥ä¿è¯é‡‘æ¨¡å¼
   - ç¼ºä»·ä½¿ç”¨è¡Œæƒ…å…œåº•

> âš ï¸ **æ³¨æ„**ï¼šæ²¡æœ‰"è·Ÿéšå¼€ä»“/åŠ ä»“/å‡ä»“/å¹³ä»“"é€‰é¡¹ã€‚
> ç³»ç»Ÿä¼š**æ— æ¡ä»¶è·Ÿéš**é¢†èˆªå‘˜çš„æ‰€æœ‰æ“ä½œï¼ˆåªè¦æ˜¯æˆ‘ä»¬è·Ÿéšçš„ä»“ä½ï¼‰ã€‚

```tsx
// é…ç½®è¡¨å•ç¤ºä¾‹
const CopyTradeConfigForm = () => {
  return (
    <form>
      {/* Provider é€‰æ‹© */}
      <Select name="provider_type" label="æ•°æ®æº">
        <option value="hyperliquid">Hyperliquid é’±åŒ…</option>
        <option value="okx">OKX äº¤æ˜“å‘˜</option>
      </Select>
      
      {/* é¢†èˆªå‘˜ ID */}
      <Input 
        name="leader_id" 
        label="é¢†èˆªå‘˜åœ°å€/ID"
        placeholder="0x... æˆ– uniqueName"
      />
      
      {/* è·Ÿå•ç³»æ•° */}
      <Input 
        name="copy_ratio" 
        type="number"
        label="è·Ÿå•ç³»æ•° (%)"
        placeholder="100"
        suffix="%"
      />
      
      {/* é¢„è­¦é˜ˆå€¼ï¼ˆå¯é€‰ï¼‰ */}
      <Input 
        name="min_trade_warn" 
        type="number"
        label="å°é¢é¢„è­¦é˜ˆå€¼ (USDT)"
        placeholder="10"
        helperText="ä½äºæ­¤é‡‘é¢ä¼šè®°å½•é¢„è­¦æ—¥å¿—ï¼ˆä¸é˜»æ­¢äº¤æ˜“ï¼‰"
      />
      
      <Input 
        name="max_trade_warn" 
        type="number"
        label="å¤§é¢é¢„è­¦é˜ˆå€¼ (USDT)"
        placeholder="0 = ä¸é¢„è­¦"
        helperText="é«˜äºæ­¤é‡‘é¢ä¼šè®°å½•é¢„è­¦æ—¥å¿—ï¼ˆä¸é˜»æ­¢äº¤æ˜“ï¼‰"
      />
      
      {/* åŒæ­¥é€‰é¡¹ */}
      <Checkbox name="sync_leverage" label="åŒæ­¥æ æ†" defaultChecked />
      <Checkbox name="sync_margin_mode" label="åŒæ­¥ä¿è¯é‡‘æ¨¡å¼" defaultChecked />
      <Checkbox name="use_fallback_price" label="ç¼ºä»·ä½¿ç”¨è¡Œæƒ…å…œåº•" defaultChecked />
      
      {/* é‡è¦æç¤º */}
      <Alert type="info">
        ğŸ’¡ ç³»ç»Ÿä¼šæ— æ¡ä»¶è·Ÿéšé¢†èˆªå‘˜çš„æ‰€æœ‰äº¤æ˜“æ“ä½œã€‚
        é¢„è­¦é˜ˆå€¼ä»…ç”¨äºè®°å½•æ—¥å¿—ï¼Œä¸ä¼šé˜»æ­¢ä»»ä½•äº¤æ˜“ã€‚
      </Alert>
    </form>
  );
};
```

### 8.3 å†³ç­–æ—¥å¿—å¤ç”¨

è·Ÿå•äº§ç”Ÿçš„å†³ç­–å®Œå…¨å…¼å®¹ç°æœ‰ AI å†³ç­–æ ¼å¼ï¼š

```typescript
// å†³ç­–æ—¥å¿—å±•ç¤ºæ— éœ€ä¿®æ”¹
// DecisionCard ç»„ä»¶å¯ç›´æ¥å¤ç”¨

interface DecisionRecord {
  timestamp: string;
  cycle_number: number;
  input_prompt: string;        // è·Ÿå•æ¨¡å¼ä¸‹ä¸ºä¿¡å·æè¿°
  cot_trace: string;           // è·Ÿå•æ¨¡å¼ä¸‹ä¸ºè®¡ç®—è¿‡ç¨‹
  decision_json: string;       // æ ‡å‡† Decision JSON
  // ... å…¶ä»–å­—æ®µå®Œå…¨å…¼å®¹
}
```

---

## 9. é£é™©é¢„è­¦æœºåˆ¶

> âš ï¸ **é‡è¦è®¾è®¡åŸåˆ™**ï¼šè·Ÿå•ç³»ç»Ÿä¸é™åˆ¶ä»»ä½•äº¤æ˜“åŠ¨ä½œï¼Œåªåšé¢„è­¦æ—¥å¿—ã€‚é¢†èˆªå‘˜çš„æ‰€æœ‰æ“ä½œéƒ½ä¼šè¢«æ‰§è¡Œã€‚

### 9.1 é¢„è­¦æ—¥å¿—ç³»ç»Ÿ

```go
// copytrade/warning/warning.go

package warning

import (
    "time"
    "nofx/logger"
)

// WarningType é¢„è­¦ç±»å‹
type WarningType string

const (
    WarnLowValue           WarningType = "low_value"            // é‡‘é¢è¾ƒå°
    WarnHighValue          WarningType = "high_value"           // é‡‘é¢è¾ƒå¤§
    WarnInsufficientBalance WarningType = "insufficient_balance" // ä½™é¢ä¸è¶³
    WarnHighFrequency      WarningType = "high_frequency"       // é«˜é¢‘æ“ä½œ
    WarnHighLeverage       WarningType = "high_leverage"        // é«˜æ æ†
    WarnLargePositionRatio WarningType = "large_position_ratio" // ä»“ä½å æ¯”å¤§
)

// Warning é¢„è­¦è®°å½•
type Warning struct {
    Timestamp   time.Time   `json:"timestamp"`
    TraderID    string      `json:"trader_id"`
    LeaderID    string      `json:"leader_id"`
    Symbol      string      `json:"symbol"`
    Type        WarningType `json:"type"`
    Message     string      `json:"message"`
    
    // ä¿¡å·è¯¦æƒ…
    SignalAction string  `json:"signal_action"`
    SignalValue  float64 `json:"signal_value"`
    CopyValue    float64 `json:"copy_value"`
    
    // æ‰§è¡ŒçŠ¶æ€ï¼ˆé¢„è­¦ä¸é˜»æ­¢æ‰§è¡Œï¼‰
    Executed    bool      `json:"executed"`
    ExecutedAt  time.Time `json:"executed_at,omitempty"`
}

// WarningLogger é¢„è­¦æ—¥å¿—è®°å½•å™¨
type WarningLogger struct {
    traderID string
    leaderID string
    warnings []Warning
}

func NewWarningLogger(traderID, leaderID string) *WarningLogger {
    return &WarningLogger{
        traderID: traderID,
        leaderID: leaderID,
        warnings: make([]Warning, 0),
    }
}

// Log è®°å½•é¢„è­¦ï¼ˆä¸é˜»æ­¢äº¤æ˜“ï¼‰
func (wl *WarningLogger) Log(w Warning) {
    w.Timestamp = time.Now()
    w.TraderID = wl.traderID
    w.LeaderID = wl.leaderID
    w.Executed = true // é¢„è­¦ä¸é˜»æ­¢ï¼Œæ€»æ˜¯æ‰§è¡Œ
    w.ExecutedAt = time.Now()
    
    wl.warnings = append(wl.warnings, w)
    
    // è¾“å‡ºåˆ°æ—¥å¿—
    logger.Warnf("âš ï¸ [è·Ÿå•é¢„è­¦] %s | %s | %s", w.Type, w.Symbol, w.Message)
}

// GetRecentWarnings è·å–æœ€è¿‘çš„é¢„è­¦è®°å½•
func (wl *WarningLogger) GetRecentWarnings(limit int) []Warning {
    if len(wl.warnings) <= limit {
        return wl.warnings
    }
    return wl.warnings[len(wl.warnings)-limit:]
}
```

### 9.2 é¢„è­¦è§¦å‘æ¡ä»¶

| é¢„è­¦ç±»å‹ | è§¦å‘æ¡ä»¶ | å¤„ç†æ–¹å¼ |
|---------|---------|---------|
| `low_value` | è·Ÿå•é‡‘é¢ < 10 USDT | è®°å½•é¢„è­¦ï¼Œ**ä»æ‰§è¡Œ** |
| `high_value` | è·Ÿå•é‡‘é¢ > è®¾å®šä¸Šé™ | è®°å½•é¢„è­¦ï¼Œ**ä»æ‰§è¡Œï¼ˆä¸æˆªæ–­ï¼‰** |
| `insufficient_balance` | å¯ç”¨ä½™é¢ä¸è¶³ | è®°å½•é¢„è­¦ï¼Œ**ç”¨æœ€å¤§å¯ç”¨ä½™é¢æ‰§è¡Œ** |
| `high_frequency` | åŒå¸ç§ 30 ç§’å†…é‡å¤æ“ä½œ | è®°å½•é¢„è­¦ï¼Œ**ä»æ‰§è¡Œ** |
| `high_leverage` | æ æ† > 20x | è®°å½•é¢„è­¦ï¼Œ**ä»æ‰§è¡Œ** |
| `large_position_ratio` | å•ä»“ä½ > è´¦æˆ· 50% | è®°å½•é¢„è­¦ï¼Œ**ä»æ‰§è¡Œ** |

### 9.3 ç†”æ–­æœºåˆ¶ï¼ˆä»…ç”¨äºç³»ç»Ÿå¼‚å¸¸ï¼‰

> ç†”æ–­æœºåˆ¶åªåœ¨**ç³»ç»Ÿå±‚é¢å¼‚å¸¸**æ—¶è§¦å‘ï¼ˆå¦‚ API è¿ç»­å¤±è´¥ï¼‰ï¼Œ**ä¸ç”¨äºé™åˆ¶äº¤æ˜“åŠ¨ä½œ**ã€‚

```go
// copytrade/engine/circuit_breaker.go

type CircuitBreaker struct {
    failureCount     int
    lastFailure      time.Time
    state            string // "closed" | "open" | "half-open"
    
    threshold        int           // å¤±è´¥é˜ˆå€¼ï¼ˆé»˜è®¤ 10ï¼‰
    resetTimeout     time.Duration // é‡ç½®è¶…æ—¶ï¼ˆé»˜è®¤ 60sï¼‰
}

// ä»…åœ¨ä»¥ä¸‹æƒ…å†µè§¦å‘ç†”æ–­ï¼š
// 1. API è°ƒç”¨è¿ç»­å¤±è´¥ 10 æ¬¡
// 2. ç½‘ç»œè¿æ¥ä¸­æ–­
// 3. äº¤æ˜“æ‰€è¿”å›ç³»ç»Ÿé”™è¯¯
//
// ä¸ä¼šå› ä¸ºä»¥ä¸‹åŸå› è§¦å‘ç†”æ–­ï¼š
// 1. ä½™é¢ä¸è¶³
// 2. è·Ÿå•é‡‘é¢è¿‡å¤§/è¿‡å°
// 3. é«˜é¢‘äº¤æ˜“
// 4. ä»»ä½•é¢†èˆªå‘˜çš„äº¤æ˜“åŠ¨ä½œ
```

### 9.4 å¼‚å¸¸å¤„ç†ï¼ˆä¸é˜»æ­¢äº¤æ˜“ï¼‰

```go
func (e *CopyTradeEngine) processSignal(signal *TradeSignal) (*decision.FullDecision, error) {
    // ç³»ç»Ÿç†”æ–­æ£€æŸ¥ï¼ˆä»…æ£€æŸ¥ API çº§åˆ«å¼‚å¸¸ï¼‰
    if !e.circuitBreaker.Allow() {
        // ç†”æ–­æ—¶ç­‰å¾…æ¢å¤ï¼Œä½†ä¸ä¸¢å¼ƒä¿¡å·
        logger.Warnf("âš ï¸ ç³»ç»Ÿç†”æ–­ä¸­ï¼Œç­‰å¾…æ¢å¤åé‡è¯•...")
        time.Sleep(5 * time.Second)
    }
    
    defer func() {
        if r := recover(); r != nil {
            logger.Errorf("ğŸ”¥ å¼•æ“å¼‚å¸¸: %v", r)
            e.circuitBreaker.RecordFailure()
            // æ³¨æ„ï¼šå³ä½¿ panic ä¹Ÿä¸ä¸¢å¼ƒä¿¡å·ï¼Œä¼šåœ¨ä¸‹æ¬¡è½®è¯¢æ—¶é‡è¯•
        }
    }()
    
    // åˆ¤æ–­æ˜¯å¦åº”è¯¥è·Ÿéšï¼ˆåªè·Ÿæ–°å¼€ä»“è§„åˆ™ï¼‰
    follow, reason := e.shouldFollowSignal(signal)
    if !follow {
        logger.Infof("ğŸ“‹ è·³è¿‡ä¿¡å·: %s", reason)
        return nil, nil // è¿™æ˜¯æ­£å¸¸é€»è¾‘è·³è¿‡ï¼Œä¸æ˜¯é”™è¯¯
    }
    
    // è®¡ç®—è·Ÿå•é‡‘é¢ï¼ˆå¸¦é¢„è­¦ï¼‰
    copySize, warnings := e.calculateCopySize(signal)
    
    // è®°å½•æ‰€æœ‰é¢„è­¦
    for _, w := range warnings {
        e.warningLogger.Log(w)
    }
    
    // æ— è®ºæœ‰å¤šå°‘é¢„è­¦ï¼Œéƒ½ç»§ç»­æ‰§è¡Œ
    dec := e.buildDecision(signal, copySize)
    
    e.circuitBreaker.RecordSuccess()
    return dec, nil
}
```

### 9.5 é¢„è­¦æ—¥å¿—å±•ç¤º

é¢„è­¦æ—¥å¿—ä¼šåœ¨å‰ç«¯å†³ç­–æ—¥å¿—ä¸­å±•ç¤ºï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

```json
{
  "timestamp": "2025-12-16T14:30:00Z",
  "trader_id": "trader_001",
  "cycle_number": 42,
  "decision_source": "copy_trade",
  "leader_id": "0x856c35...",
  "warnings": [
    {
      "type": "high_value",
      "message": "è·Ÿå•é‡‘é¢è¾ƒå¤§ (5000 USDT > 1000 ä¸Šé™)ï¼Œä»æŒ‰åŸé‡‘é¢æ‰§è¡Œ"
    },
    {
      "type": "high_leverage", 
      "message": "åŒæ­¥æ æ† 25x è¾ƒé«˜ï¼Œä»æ‰§è¡Œ"
    }
  ],
  "executed": true,
  "decision": {
    "symbol": "BTCUSDT",
    "action": "open_long",
    "position_size_usd": 5000,
    "leverage": 25
  }
}
```

---

## 10. æ—¥å¿—è§„èŒƒ

### 10.1 æ—¥å¿—åˆ†ç±»

| æ—¥å¿—ç±»åˆ« | æ ‡è¯†å‰ç¼€ | ç”¨é€” |
|---------|---------|------|
| **è¿æ¥æ—¥å¿—** | `ğŸ”—` | WebSocket/API è¿æ¥çŠ¶æ€ |
| **ç›‘æ§æ—¥å¿—** | `ğŸ‘ï¸` | é¢†èˆªå‘˜çŠ¶æ€ç›‘æ§ |
| **ä¿¡å·æ—¥å¿—** | `ğŸ“¡` | æ¥æ”¶åˆ°çš„äº¤æ˜“ä¿¡å· |
| **åˆ¤æ–­æ—¥å¿—** | `ğŸ¯` | è·Ÿå•åˆ¤æ–­ï¼ˆè·Ÿ/ä¸è·Ÿï¼‰ |
| **è®¡ç®—æ—¥å¿—** | `ğŸ“Š` | æ¯”ä¾‹è®¡ç®—è¿‡ç¨‹ |
| **æ‰§è¡Œæ—¥å¿—** | `âš¡` | äº¤æ˜“æ‰§è¡ŒçŠ¶æ€ |
| **é¢„è­¦æ—¥å¿—** | `âš ï¸` | é£æ§é¢„è­¦ï¼ˆä¸é˜»æ­¢ï¼‰ |
| **é”™è¯¯æ—¥å¿—** | `âŒ` | é”™è¯¯å’Œå¼‚å¸¸ |
| **ç³»ç»Ÿæ—¥å¿—** | `ğŸ”§` | ç³»ç»ŸçŠ¶æ€å˜æ›´ |

### 10.2 å…³é”®æ—¥å¿—ç‚¹

#### 10.2.1 å¯åŠ¨é˜¶æ®µ

```go
// è·Ÿå•æœåŠ¡å¯åŠ¨
logger.Infof("ğŸ”§ [%s] è·Ÿå•æœåŠ¡å¯åŠ¨ (provider=%s, leader=%s)", 
    traderID, providerType, leaderID)

// WebSocket è¿æ¥
logger.Infof("ğŸ”— [%s] WS è¿æ¥æˆåŠŸ local=%s remote=%s", 
    traderID, localAddr, remoteAddr)

// è®¢é˜…æˆåŠŸ
logger.Infof("ğŸ”— [%s] WS è®¢é˜…æˆåŠŸ channel=%s user=%s", 
    traderID, channel, leaderID)

// åˆå§‹çŠ¶æ€åŒæ­¥
logger.Infof("ğŸ‘ï¸ [%s] é¢†èˆªå‘˜çŠ¶æ€åŒæ­¥å®Œæˆ equity=%.2f positions=%d", 
    traderID, leaderEquity, len(positions))
```

#### 10.2.2 ä¿¡å·æ¥æ”¶

```go
// æ”¶åˆ°æ–°ä¿¡å·
logger.Infof("ğŸ“¡ [%s] æ”¶åˆ°ä¿¡å· | %s %s %s | ä»·æ ¼=%.4f æ•°é‡=%.4f ä»·å€¼=%.2f", 
    traderID, symbol, action, posSide, price, size, value)

// ä¿¡å·å»é‡è·³è¿‡
logger.Debugf("ğŸ“¡ [%s] ä¿¡å·å·²å¤„ç†ï¼Œè·³è¿‡ | signal_id=%s", 
    traderID, signalID)
```

#### 10.2.3 è·Ÿå•åˆ¤æ–­

```go
// å†³å®šè·Ÿéš
logger.Infof("ğŸ¯ [%s] âœ… è·Ÿéš | %s | åŸå› : %s", 
    traderID, symbol, reason)

// å†³å®šä¸è·Ÿ
logger.Infof("ğŸ¯ [%s] âŒ è·³è¿‡ | %s | åŸå› : %s", 
    traderID, symbol, reason)

// åŠ¨ä½œç±»å‹åˆ¤æ–­
logger.Infof("ğŸ¯ [%s] åŠ¨ä½œåˆ¤æ–­ | %s | é¢†èˆªå‘˜ä»“ä½=%.4f â†’ %s", 
    traderID, symbol, leaderPositionSize, actionType) // "open/add/reduce/close"
```

#### 10.2.4 æ¯”ä¾‹è®¡ç®—

```go
// è·Ÿå•æ¯”ä¾‹è®¡ç®—
logger.Infof("ğŸ“Š [%s] æ¯”ä¾‹è®¡ç®— | %s | "+
    "é¢†èˆªå‘˜: äº¤æ˜“=%.2f æƒç›Š=%.2f å æ¯”=%.2f%% | "+
    "è·Ÿéšè€…: æƒç›Š=%.2f ç³»æ•°=%.0f%% â†’ è·Ÿå•=%.2f", 
    traderID, symbol,
    leaderTradeValue, leaderEquity, leaderRatio*100,
    followerEquity, copyRatio*100, copySize)

// å‡ä»“æ¯”ä¾‹è®¡ç®—
logger.Infof("ğŸ“Š [%s] å‡ä»“è®¡ç®— | %s | "+
    "å‡ä»“é‡=%.4f å‡ä»“å‰=%.4f â†’ å‡ä»“æ¯”ä¾‹=%.2f%%", 
    traderID, symbol, reduceSize, previousSize, reduceRatio*100)
```

#### 10.2.5 é¢„è­¦æ—¥å¿—

```go
// å°é¢é¢„è­¦
logger.Warnf("âš ï¸ [%s] é¢„è­¦:å°é¢ | %s | é‡‘é¢=%.2f (é˜ˆå€¼=%.2f) | ä»æ‰§è¡Œ", 
    traderID, symbol, copySize, minWarn)

// å¤§é¢é¢„è­¦
logger.Warnf("âš ï¸ [%s] é¢„è­¦:å¤§é¢ | %s | é‡‘é¢=%.2f (é˜ˆå€¼=%.2f) | ä»æ‰§è¡Œ", 
    traderID, symbol, copySize, maxWarn)

// ä½™é¢ä¸è¶³é¢„è­¦
logger.Warnf("âš ï¸ [%s] é¢„è­¦:ä½™é¢ä¸è¶³ | %s | éœ€è¦=%.2f å¯ç”¨=%.2f | ä»¥æœ€å¤§å¯ç”¨æ‰§è¡Œ", 
    traderID, symbol, copySize, availableBalance)

// é«˜æ æ†é¢„è­¦
logger.Warnf("âš ï¸ [%s] é¢„è­¦:é«˜æ æ† | %s | æ æ†=%dx | ä»æ‰§è¡Œ", 
    traderID, symbol, leverage)
```

#### 10.2.6 æ‰§è¡Œæ—¥å¿—

```go
// å¼€å§‹æ‰§è¡Œ
logger.Infof("âš¡ [%s] æ‰§è¡Œå¼€å§‹ | %s %s | é‡‘é¢=%.2f æ æ†=%dx", 
    traderID, action, symbol, positionSize, leverage)

// æ‰§è¡ŒæˆåŠŸ
logger.Infof("âš¡ [%s] æ‰§è¡ŒæˆåŠŸ | %s %s | æˆäº¤ä»·=%.4f æ•°é‡=%.4f", 
    traderID, action, symbol, fillPrice, fillQty)

// æ‰§è¡Œå¤±è´¥
logger.Errorf("âŒ [%s] æ‰§è¡Œå¤±è´¥ | %s %s | é”™è¯¯: %s", 
    traderID, action, symbol, err.Error())
```

#### 10.2.7 é”™è¯¯æ—¥å¿—

```go
// API é”™è¯¯
logger.Errorf("âŒ [%s] APIé”™è¯¯ | %s | code=%s msg=%s", 
    traderID, apiName, code, message)

// WebSocket æ–­å¼€
logger.Errorf("âŒ [%s] WSæ–­å¼€ | é”™è¯¯: %s | å°†åœ¨ %ds åé‡è¿", 
    traderID, err.Error(), reconnectDelay)

// æ•°æ®è§£æé”™è¯¯
logger.Errorf("âŒ [%s] æ•°æ®è§£æå¤±è´¥ | ç±»å‹=%s | åŸå§‹æ•°æ®: %s", 
    traderID, dataType, rawData)
```

### 10.3 æ—¥å¿—æ ¼å¼è§„èŒƒ

```
[çº§åˆ«] [æ—¶é—´] [æ–‡ä»¶:è¡Œå·] [emoji] [trader_id] æ¶ˆæ¯ | å­—æ®µ1=å€¼1 å­—æ®µ2=å€¼2
```

**ç¤ºä¾‹ï¼š**
```
INFO  [2025-12-16 09:25:04] copytrade/engine.go:156 ğŸ“¡ [æµ‹è¯•å‘˜] æ”¶åˆ°ä¿¡å· | BTCUSDT open long | ä»·æ ¼=95000.00 æ•°é‡=0.1 ä»·å€¼=9500.00
INFO  [2025-12-16 09:25:04] copytrade/engine.go:189 ğŸ¯ [æµ‹è¯•å‘˜] âœ… è·Ÿéš | BTCUSDT | åŸå› : æ–°å¼€ä»“ä¿¡å·ï¼Œæœ¬åœ°æ— æŒä»“
INFO  [2025-12-16 09:25:04] copytrade/engine.go:234 ğŸ“Š [æµ‹è¯•å‘˜] æ¯”ä¾‹è®¡ç®— | BTCUSDT | é¢†èˆªå‘˜: äº¤æ˜“=9500.00 æƒç›Š=100000.00 å æ¯”=9.50% | è·Ÿéšè€…: æƒç›Š=1000.00 ç³»æ•°=100% â†’ è·Ÿå•=95.00
INFO  [2025-12-16 09:25:04] copytrade/engine.go:278 âš¡ [æµ‹è¯•å‘˜] æ‰§è¡Œå¼€å§‹ | open_long BTCUSDT | é‡‘é¢=95.00 æ æ†=10x
INFO  [2025-12-16 09:25:05] copytrade/engine.go:312 âš¡ [æµ‹è¯•å‘˜] æ‰§è¡ŒæˆåŠŸ | open_long BTCUSDT | æˆäº¤ä»·=95012.50 æ•°é‡=0.001
```

### 10.4 æ—¥å¿—çº§åˆ«ä½¿ç”¨

| çº§åˆ« | ä½¿ç”¨åœºæ™¯ |
|------|---------|
| **DEBUG** | å»é‡è·³è¿‡ã€è¯¦ç»†è®¡ç®—è¿‡ç¨‹ã€è°ƒè¯•ä¿¡æ¯ |
| **INFO** | æ­£å¸¸æµç¨‹ï¼šå¯åŠ¨ã€è¿æ¥ã€ä¿¡å·ã€åˆ¤æ–­ã€æ‰§è¡Œ |
| **WARN** | é¢„è­¦ï¼ˆä¸é˜»æ­¢äº¤æ˜“ï¼‰ã€é‡è¿ã€éè‡´å‘½å¼‚å¸¸ |
| **ERROR** | æ‰§è¡Œå¤±è´¥ã€APIé”™è¯¯ã€è§£æé”™è¯¯ |

### 10.5 ç»“æ„åŒ–æ—¥å¿—å­—æ®µ

```go
// å»ºè®®ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—ä¾¿äºæ£€ç´¢å’Œåˆ†æ
type CopyTradeLog struct {
    Timestamp   time.Time `json:"ts"`
    TraderID    string    `json:"trader_id"`
    LeaderID    string    `json:"leader_id"`
    LogType     string    `json:"log_type"`     // signal|judge|calc|exec|warn|error
    Symbol      string    `json:"symbol,omitempty"`
    Action      string    `json:"action,omitempty"`
    
    // ä¿¡å·ç›¸å…³
    SignalID    string    `json:"signal_id,omitempty"`
    SignalPrice float64   `json:"signal_price,omitempty"`
    SignalValue float64   `json:"signal_value,omitempty"`
    
    // åˆ¤æ–­ç›¸å…³
    Followed    *bool     `json:"followed,omitempty"`
    Reason      string    `json:"reason,omitempty"`
    
    // è®¡ç®—ç›¸å…³
    LeaderEquity   float64 `json:"leader_equity,omitempty"`
    FollowerEquity float64 `json:"follower_equity,omitempty"`
    CopyRatio      float64 `json:"copy_ratio,omitempty"`
    CopySize       float64 `json:"copy_size,omitempty"`
    
    // æ‰§è¡Œç›¸å…³
    FillPrice   float64 `json:"fill_price,omitempty"`
    FillQty     float64 `json:"fill_qty,omitempty"`
    
    // é”™è¯¯ç›¸å…³
    Error       string  `json:"error,omitempty"`
}

// æ—¥å¿—è¾“å‡ºç¤ºä¾‹
func (e *CopyTradeEngine) logSignal(signal *TradeSignal) {
    log := CopyTradeLog{
        Timestamp:   time.Now(),
        TraderID:    e.traderID,
        LeaderID:    e.config.LeaderID,
        LogType:     "signal",
        Symbol:      signal.Fill.Symbol,
        Action:      signal.Fill.Action,
        SignalID:    signal.Fill.ID,
        SignalPrice: signal.Fill.Price,
        SignalValue: signal.Fill.Value,
    }
    
    // è¾“å‡ºä¸º JSONï¼ˆä¾¿äº ELK/Loki ç­‰æ—¥å¿—ç³»ç»Ÿæ£€ç´¢ï¼‰
    jsonBytes, _ := json.Marshal(log)
    logger.Infof("ğŸ“¡ [%s] %s", e.traderID, string(jsonBytes))
}
```

### 10.6 é—®é¢˜æ’æŸ¥æŒ‡å—

| é—®é¢˜ç°è±¡ | æ£€æŸ¥æ—¥å¿— | å…³é”®å­—æ®µ |
|---------|---------|---------|
| **æ²¡æ”¶åˆ°ä¿¡å·** | è¿æ¥æ—¥å¿—ã€ç›‘æ§æ—¥å¿— | `WS connected`, `subscribed` |
| **ä¿¡å·æ²¡è·Ÿ** | åˆ¤æ–­æ—¥å¿— | `è·³è¿‡`, `åŸå› ` |
| **é‡‘é¢è®¡ç®—é”™è¯¯** | è®¡ç®—æ—¥å¿— | `é¢†èˆªå‘˜`, `æƒç›Š`, `è·Ÿå•` |
| **æ‰§è¡Œå¤±è´¥** | æ‰§è¡Œæ—¥å¿—ã€é”™è¯¯æ—¥å¿— | `æ‰§è¡Œå¤±è´¥`, `é”™è¯¯` |
| **ä»“ä½ä¸åŒæ­¥** | åˆ¤æ–­æ—¥å¿— | `æœ¬åœ°ä»“ä½`, `é¢†èˆªå‘˜ä»“ä½` |

### 10.7 æ¥å…¥ç°æœ‰æ—¥å¿—ç³»ç»Ÿ

> âš ï¸ **é‡è¦**ï¼šç›´æ¥ä½¿ç”¨é¡¹ç›®ç°æœ‰çš„ `logger` åŒ…ï¼Œä¸é‡å¤é€ è½®å­ã€‚

```go
// ç›´æ¥ä½¿ç”¨ç°æœ‰çš„ logger åŒ…
import "nofx/logger"

// è·Ÿå•æ¨¡å—çš„æ—¥å¿—ç›´æ¥è¾“å‡ºåˆ°ç°æœ‰æ—¥å¿—ç³»ç»Ÿ
func (e *CopyTradeEngine) logSignal(signal *TradeSignal) {
    logger.Infof("ğŸ“¡ [%s] æ”¶åˆ°ä¿¡å· | %s %s %s | ä»·æ ¼=%.4f",
        e.traderID, signal.Fill.Symbol, signal.Fill.Action, 
        signal.Fill.PositionSide, signal.Fill.Price)
}

// æ‰€æœ‰æ—¥å¿—ç»Ÿä¸€ç”±ç°æœ‰ç³»ç»Ÿç®¡ç†ï¼š
// - æ—¥å¿—çº§åˆ«æ§åˆ¶
// - æ—¥å¿—æ–‡ä»¶è½®è½¬
// - æ—¥å¿—æ ¼å¼åŒ–
// - æ—¥å¿—è¾“å‡ºç›®æ ‡
```

---

## 11. å®ç°è·¯çº¿å›¾

### Phase 1: åŸºç¡€æ¡†æ¶ (Week 1)

- [ ] åˆ›å»º `copytrade/` æ¨¡å—ç›®å½•ç»“æ„
- [ ] å®ç° Provider æ¥å£å’Œ Hyperliquid Provider
- [ ] å®ç°åŸºç¡€ Tracker (è½®è¯¢æ¨¡å¼)
- [ ] å®ç°è·Ÿå•æ¯”ä¾‹è®¡ç®—å™¨
- [ ] æ•°æ®åº“è¡¨å’Œ Store å±‚
- [ ] **å®ç°æœ¬åœ°ä»“ä½å¯¹æ¯”é€»è¾‘ï¼ˆåˆ¤æ–­æ–°å¼€ä»“ vs å†å²ä»“ä½ï¼‰**

### Phase 2: å¼•æ“é›†æˆ (Week 2)

- [ ] å®ç° CopyTradeEngineï¼ˆåŒ…å«åªè·Ÿæ–°å¼€ä»“è§„åˆ™ï¼‰
- [ ] å®ç° Decision é€‚é…å™¨
- [ ] å®ç°åå‘å¼€ä»“æ‹†åˆ†å¤„ç†ï¼ˆHyperliquidï¼‰
- [ ] é›†æˆåˆ° AutoTrader (Decision Provider æ¥å£)
- [ ] æ·»åŠ  API Handler
- [ ] åŸºç¡€å‰ç«¯é…ç½® UI

### Phase 3: OKX æ”¯æŒ (Week 3)

- [ ] å®ç° OKX Provider
- [ ] å®ç° OKX Tracker
- [ ] ç»Ÿä¸€ç¬¦å·æ ¼å¼åŒ–
- [ ] å‰ç«¯ Provider åˆ‡æ¢æ”¯æŒ

### Phase 4: é¢„è­¦ç³»ç»Ÿä¸ä¼˜åŒ– (Week 4)

- [ ] **å®ç°é¢„è­¦æ—¥å¿—ç³»ç»Ÿï¼ˆä¸é˜»æ­¢äº¤æ˜“ï¼‰**
- [ ] ç³»ç»Ÿçº§ç†”æ–­æœºåˆ¶ï¼ˆä»…ç”¨äº API å¼‚å¸¸ï¼‰
- [ ] ä¿¡å·æ—¥å¿—è®°å½•
- [ ] é¢†èˆªå‘˜é¢„è§ˆ API
- [ ] æ€§èƒ½ä¼˜åŒ– (å»é‡ã€ç¼“å­˜)
- [ ] å®Œæ•´æµ‹è¯•è¦†ç›–

### Phase 5: æ–‡æ¡£ä¸å‘å¸ƒ (Week 5)

- [ ] ç”¨æˆ·æ–‡æ¡£
- [ ] API æ–‡æ¡£
- [ ] ç¤ºä¾‹é…ç½®
- [ ] ç‰ˆæœ¬å‘å¸ƒ

---

## 12. é™„å½•

### A. Hyperliquid API æ•°æ®ç»“æ„

```go
// userFills è¿”å›ç»“æ„
type HLFillRaw struct {
    Coin          string `json:"coin"`
    Px            string `json:"px"`
    Sz            string `json:"sz"`
    Side          string `json:"side"`         // "B" | "A"
    Time          int64  `json:"time"`
    StartPosition string `json:"startPosition"`
    Dir           string `json:"dir"`          // "Open Long" | "Close Short" | ...
    ClosedPnl     string `json:"closedPnl"`
    Hash          string `json:"hash"`
    Oid           int64  `json:"oid"`
    TID           int64  `json:"tid"`
    FeeToken      string `json:"feeToken"`
}

// clearinghouseState è¿”å›ç»“æ„
type HLClearinghouseState struct {
    MarginSummary struct {
        AccountValue    string `json:"accountValue"`
        TotalNtlPos     string `json:"totalNtlPos"`
        TotalRawUsd     string `json:"totalRawUsd"`
        TotalMarginUsed string `json:"totalMarginUsed"`
    } `json:"marginSummary"`
    Withdrawable   string `json:"withdrawable"`
    AssetPositions []struct {
        Type     string `json:"type"`
        Position struct {
            Coin           string `json:"coin"`
            Szi            string `json:"szi"`
            Leverage       struct {
                Type  string `json:"type"`
                Value int    `json:"value"`
            } `json:"leverage"`
            EntryPx        string `json:"entryPx"`
            PositionValue  string `json:"positionValue"`
            UnrealizedPnl  string `json:"unrealizedPnl"`
            LiquidationPx  string `json:"liquidationPx,omitempty"`
            MarginUsed     string `json:"marginUsed"`
        } `json:"position"`
    } `json:"assetPositions"`
    Time int64 `json:"time"`
}
```

### B. OKX API æ•°æ®ç»“æ„

```go
// trade-records è¿”å›ç»“æ„
type OKXTradeRecord struct {
    AvgPx     string `json:"avgPx"`
    BaseName  string `json:"baseName"`
    CTime     string `json:"cTime"`
    FillTime  string `json:"fillTime"`
    InstId    string `json:"instId"`
    InstType  string `json:"instType"`
    Lever     string `json:"lever"`
    OrdId     string `json:"ordId"`
    OrdType   string `json:"ordType"`
    PosSide   string `json:"posSide"` // "long" | "short"
    Side      string `json:"side"`    // "buy" | "sell"
    Sz        string `json:"sz"`
    Value     string `json:"value"`
}

// position-current è¿”å›ç»“æ„
type OKXPosition struct {
    AvgPx      string `json:"avgPx"`
    InstId     string `json:"instId"`
    Lever      string `json:"lever"`
    LiqPx      string `json:"liqPx"`
    Margin     string `json:"margin"`
    MarkPx     string `json:"markPx"`
    MgnMode    string `json:"mgnMode"` // "isolated" | "cross"
    NotionalUsd string `json:"notionalUsd"`
    Pos        string `json:"pos"`
    PosSide    string `json:"posSide"`
    Upl        string `json:"upl"`
}
```

### C. ç¬¦å·æ ¼å¼åŒ–

```go
// ç»Ÿä¸€ç¬¦å·æ ¼å¼: BTCUSDT

func normalizeSymbol(coin string) string {
    coin = strings.ToUpper(coin)
    if !strings.HasSuffix(coin, "USDT") {
        coin = coin + "USDT"
    }
    return coin
}

func normalizeOKXSymbol(instId string) string {
    // OKX: "BTC-USDT-SWAP" -> "BTCUSDT"
    parts := strings.Split(instId, "-")
    if len(parts) >= 2 {
        return parts[0] + parts[1]
    }
    return instId
}
```

---

## å˜æ›´è®°å½•

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ |
|------|------|----------|
| v1.0 | 2025-12-16 | åˆå§‹è®¾è®¡æ–‡æ¡£ |
| v1.1 | 2025-12-16 | é‡å¤§æ›´æ–°ï¼š<br>1. æ–°å¢ã€Œè·Ÿå•è§„åˆ™ä¸äº¤æ˜“åŠ¨ä½œã€ç« èŠ‚<br>2. æ˜ç¡®åªè·Ÿæ–°å¼€ä»“åŸåˆ™<br>3. æ–°å¢æœ¬åœ°ä»“ä½å¯¹æ¯”åˆ¤æ–­é€»è¾‘<br>4. æ–°å¢ Hyperliquid åå‘å¼€ä»“å¤„ç†æ–¹æ¡ˆ<br>5. é£æ§æ”¹ä¸ºé¢„è­¦æ¨¡å¼ï¼ˆä¸é™åˆ¶äº¤æ˜“ï¼‰<br>6. ç§»é™¤ follow_open/add/reduce/close é€‰é¡¹<br>7. æ–°å¢é¢„è­¦æ—¥å¿—ç³»ç»Ÿ |
| v1.2 | 2025-12-16 | è¡¥å……å‡ä»“ vs å¹³ä»“åˆ¤æ–­é€»è¾‘ï¼š<br>1. é€šè¿‡é¢†èˆªå‘˜å®æ—¶æŒä»“åˆ¤æ–­å‡ä»“/å¹³ä»“<br>2. é¢†èˆªå‘˜ä»“ä½=0 â†’ å¹³ä»“<br>3. é¢†èˆªå‘˜ä»“ä½>0 â†’ å‡ä»“<br>4. æ–°å¢ calculateReduceRatio è®¡ç®—å‡ä»“æ¯”ä¾‹ |
| v1.3 | 2025-12-16 | æ–°å¢æ—¥å¿—è§„èŒƒç« èŠ‚ï¼š<br>1. æ—¥å¿—åˆ†ç±»ï¼ˆè¿æ¥/ç›‘æ§/ä¿¡å·/åˆ¤æ–­/è®¡ç®—/æ‰§è¡Œ/é¢„è­¦/é”™è¯¯ï¼‰<br>2. å…³é”®æ—¥å¿—ç‚¹å’Œæ ¼å¼è§„èŒƒ<br>3. ç»“æ„åŒ–æ—¥å¿—å­—æ®µå®šä¹‰<br>4. é—®é¢˜æ’æŸ¥æŒ‡å—<br>5. æ—¥å¿—å­˜å‚¨å»ºè®® |
| v1.4 | 2025-12-16 | ç²¾ç®€æ¨¡å—ç»“æ„ï¼š<br>1. æ—¥å¿—æ¥å…¥ç°æœ‰ logger ç³»ç»Ÿ<br>2. ç›®å½•ç»“æ„ä» 15+ æ–‡ä»¶ç²¾ç®€åˆ° 4 æ–‡ä»¶<br>3. åˆ é™¤å†—ä½™çš„ tracker/ã€config/ ç›®å½•<br>4. åˆå¹¶ providerã€engine é€»è¾‘<br>5. æ€»ä»£ç é‡é¢„ä¼° ~850 è¡Œ |
| v1.5 | 2025-12-16 | å…¨é¢å¤ç”¨ç°æœ‰ç³»ç»Ÿï¼š<br>1. å¤šè´¦æˆ·éš”ç¦»å¤ç”¨ç°æœ‰ trader_id æœºåˆ¶<br>2. è·Ÿå•é…ç½®ä½œä¸º Trader å±æ€§ï¼Œä¸æ˜¯ç‹¬ç«‹å®ä½“<br>3. å¤ç”¨ TraderManagerã€æ‰§è¡Œå™¨ã€ä»“ä½æŸ¥è¯¢ç­‰<br>4. æ•°æ®åº“æ‰©å±•ç°æœ‰ traders è¡¨<br>5. è·Ÿå• = Trader çš„"å†³ç­–æº"é€‰é¡¹ |
| v1.6 | 2025-12-16 | è¡¥å……è¾¹ç•Œæƒ…å†µå¤„ç†ï¼š<br>1. ç³»ç»Ÿé‡å¯ï¼šå¤ç”¨ç°æœ‰ PositionSyncManagerï¼Œä»äº¤æ˜“æ‰€è·å–çœŸå®ä»“ä½<br>2. ç”¨æˆ·æ‰‹åŠ¨æ“ä½œï¼šå°Šé‡ç”¨æˆ·è¡Œä¸ºï¼Œåç»­å¿½ç•¥æ˜¯åˆç†çš„<br>3. åå‘å¼€ä»“ä¹±åºï¼šæ–°å¢åå‘çª—å£ä¿æŠ¤ï¼ˆé˜²å¾¡æ€§ç¼–ç¨‹ï¼‰ |

---

**æ–‡æ¡£ç»“æŸ**

